import{b as X}from"./chunk-7Y43KFLQ.js";import{h as ae}from"./chunk-W32OAXCN.js";import{j as Ke}from"./chunk-HCXDFA3E.js";import{a as q,b as oe,c as Le,d as ze,f as qe}from"./chunk-2UDOPISM.js";import{$a as je,A as ie,C as We,E as A,F as I,Fa as Ve,H as Y,J as Me,K as Oe,O as L,P as ne,U as D,W as F,_ as g,a as y,b as fe,ba as $e,da as o,ea as He,g as Q,h as te,i as re,j as Te,l as se,la as P,m as d,mc as z,n as v,pa as Se,q as Pe,r as Fe,s as Ue,t as w,uc as Ne,v as V,va as xe,y as K}from"./chunk-ULVRKX75.js";var Be={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bits:6};var _e={parse:function(u,e){return St(u,Be,e)},stringify:function(u,e){return pt(u,Be,e)}};function St(s,u,e){var t;if(e===void 0&&(e={}),!u.codes){u.codes={};for(var r=0;r<u.chars.length;++r)u.codes[u.chars[r]]=r}if(!e.loose&&s.length*u.bits&7)throw new SyntaxError("Invalid padding");for(var i=s.length;s[i-1]==="=";)if(--i,!e.loose&&!((s.length-i)*u.bits&7))throw new SyntaxError("Invalid padding");for(var n=new((t=e.out)!=null?t:Uint8Array)(i*u.bits/8|0),a=0,c=0,l=0,h=0;h<i;++h){var f=u.codes[s[h]];if(f===void 0)throw new SyntaxError("Invalid character "+s[h]);c=c<<u.bits|f,a+=u.bits,a>=8&&(a-=8,n[l++]=255&c>>a)}if(a>=u.bits||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return n}function pt(s,u,e){e===void 0&&(e={});for(var t=e,r=t.pad,i=r===void 0?!0:r,n=(1<<u.bits)-1,a="",c=0,l=0,h=0;h<s.length;++h)for(l=l<<8|255&s[h],c+=8;c>u.bits;)c-=u.bits,a+=u.chars[n&l>>c];if(c&&(a+=u.chars[n&l<<u.bits-c]),i)for(;a.length*u.bits&7;)a+="=";return a}var ce=class{},we=class{constructor(u){this.passedConfigs=u}loadConfigs(){return Array.isArray(this.passedConfigs)?d(this.passedConfigs):d([this.passedConfigs])}};function kt(s){if(!s?.config)throw new Error("No config provided!");return new we(s.config)}var Je=new $e("PASSED_CONFIG"),Ze=(()=>{class s{static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),It=(()=>{class s{logError(e,...t){console.error(e,...t)}logWarning(e,...t){console.warn(e,...t)}logDebug(e,...t){console.debug(e,...t)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Z=(function(s){return s[s.None=0]="None",s[s.Debug=1]="Debug",s[s.Warn=2]="Warn",s[s.Error=3]="Error",s})(Z||{}),S=(()=>{class s{constructor(){this.abstractLoggerService=o(Ze)}logError(e,t,...r){if(this.loggingIsTurnedOff(e))return;let{configId:i}=e,n=this.isObject(t)?JSON.stringify(t):t;r&&r.length?this.abstractLoggerService.logError(`[ERROR] ${i} - ${n}`,...r):this.abstractLoggerService.logError(`[ERROR] ${i} - ${n}`)}logWarning(e,t,...r){if(!this.logLevelIsSet(e)||this.loggingIsTurnedOff(e)||!this.currentLogLevelIsEqualOrSmallerThan(e,Z.Warn))return;let{configId:i}=e,n=this.isObject(t)?JSON.stringify(t):t;r&&r.length?this.abstractLoggerService.logWarning(`[WARN] ${i} - ${n}`,...r):this.abstractLoggerService.logWarning(`[WARN] ${i} - ${n}`)}logDebug(e,t,...r){if(!e||!this.logLevelIsSet(e)||this.loggingIsTurnedOff(e)||!this.currentLogLevelIsEqualOrSmallerThan(e,Z.Debug))return;let{configId:i}=e,n=this.isObject(t)?JSON.stringify(t):t;r&&r.length?this.abstractLoggerService.logDebug(`[DEBUG] ${i} - ${n}`,...r):this.abstractLoggerService.logDebug(`[DEBUG] ${i} - ${n}`)}currentLogLevelIsEqualOrSmallerThan(e,t){let{logLevel:r}=e||{};return r?r<=t:!1}logLevelIsSet(e){let{logLevel:t}=e||{};return t===null?!1:t!==void 0}loggingIsTurnedOff(e){let{logLevel:t}=e||{};return t===Z.None}isObject(e){return Object.prototype.toString.call(e)==="[object Object]"}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),C=(function(s){return s[s.ConfigLoaded=0]="ConfigLoaded",s[s.CheckingAuth=1]="CheckingAuth",s[s.CheckingAuthFinished=2]="CheckingAuthFinished",s[s.CheckingAuthFinishedWithError=3]="CheckingAuthFinishedWithError",s[s.ConfigLoadingFailed=4]="ConfigLoadingFailed",s[s.CheckSessionReceived=5]="CheckSessionReceived",s[s.UserDataChanged=6]="UserDataChanged",s[s.NewAuthenticationResult=7]="NewAuthenticationResult",s[s.TokenExpired=8]="TokenExpired",s[s.IdTokenExpired=9]="IdTokenExpired",s[s.SilentRenewStarted=10]="SilentRenewStarted",s[s.SilentRenewFailed=11]="SilentRenewFailed",s})(C||{}),j=(()=>{class s{constructor(){this.notify=new Te(1)}fireEvent(e,t){this.notify.next({type:e,value:t})}registerForEvents(){return this.notify.asObservable()}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),et=(()=>{class s{static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),mt=(()=>{class s{constructor(){this.loggerService=o(S),this.abstractSecurityStorage=o(et)}read(e,t){let{configId:r}=t;if(!r)return this.loggerService.logDebug(t,`Wanted to read '${e}' but configId was '${r}'`),null;if(!this.hasStorage())return this.loggerService.logDebug(t,`Wanted to read '${e}' but Storage was undefined`),null;let i=this.abstractSecurityStorage.read(r);return i?JSON.parse(i):null}write(e,t){let{configId:r}=t;return r?this.hasStorage()?(e=e||null,this.abstractSecurityStorage.write(r,JSON.stringify(e)),!0):(this.loggerService.logDebug(t,"Wanted to write but Storage was falsy"),!1):(this.loggerService.logDebug(t,`Wanted to write but configId was '${r}'`),!1)}remove(e,t){return this.hasStorage()?(this.abstractSecurityStorage.remove(e),!0):(this.loggerService.logDebug(t,`Wanted to remove '${e}' but Storage was falsy`),!1)}clear(e){return this.hasStorage()?(this.abstractSecurityStorage.clear(),!0):(this.loggerService.logDebug(e,"Wanted to clear storage but Storage was falsy"),!1)}hasStorage(){return typeof Storage<"u"}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),b=(()=>{class s{constructor(){this.browserStorageService=o(mt)}read(e,t){return(this.browserStorageService.read(e,t)||{})[e]}write(e,t,r){let i=this.browserStorageService.read(e,r)||{};return i[e]=t,this.browserStorageService.write(i,r)}remove(e,t){let r=this.browserStorageService.read(e,t)||{};delete r[e],this.browserStorageService.write(r,t)}clear(e){this.browserStorageService.clear(e)}resetStorageFlowData(e){this.remove("session_state",e),this.remove("storageSilentRenewRunning",e),this.remove("storageCodeFlowInProgress",e),this.remove("codeVerifier",e),this.remove("userData",e),this.remove("storageCustomParamsAuthRequest",e),this.remove("access_token_expires_at",e),this.remove("storageCustomParamsRefresh",e),this.remove("storageCustomParamsEndSession",e),this.remove("reusable_refresh_token",e)}resetAuthStateInStorage(e){this.remove("authzData",e),this.remove("reusable_refresh_token",e),this.remove("authnResult",e)}getAccessToken(e){return this.read("authzData",e)}getIdToken(e){return this.read("authnResult",e)?.id_token}getRefreshToken(e){let t=this.read("authnResult",e)?.refresh_token;return!t&&e.allowUnsafeReuseRefreshToken?this.read("reusable_refresh_token",e):t}getAuthenticationResult(e){return this.read("authnResult",e)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),tt=(()=>{class s{extractJwk(e,t,r=!0){if(e.length===0)throw yt;let i=e.filter(n=>t?.kid?n.kid===t.kid:!0).filter(n=>t?.use?n.use===t.use:!0).filter(n=>t?.kty?n.kty===t.kty:!0);if(i.length===0&&r)throw Rt;if(i.length>1&&t==null)throw Dt;return i}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();function Ie(s){return tt.name+": "+s}var yt={name:Ie("InvalidArgumentError"),message:"Array of keys was empty. Unable to extract"},Rt={name:Ie("NoMatchingKeysError"),message:"No key found matching the spec"},Dt={name:Ie("SeveralMatchingKeysError"),message:"More than one key found. Please use spec to filter"},Ge=3,he=(()=>{class s{constructor(){this.loggerService=o(S),this.document=o(P)}getTokenExpirationDate(e){if(!Object.prototype.hasOwnProperty.call(e,"exp"))return new Date(new Date().toUTCString());let t=new Date(0);return t.setUTCSeconds(e.exp),t}getSigningInputFromToken(e,t,r){if(!this.tokenIsValid(e,r))return"";let i=this.getHeaderFromToken(e,t,r),n=this.getPayloadFromToken(e,t,r);return[i,n].join(".")}getHeaderFromToken(e,t,r){return this.tokenIsValid(e,r)?this.getPartOfToken(e,0,t):{}}getPayloadFromToken(e,t,r){return r?this.tokenIsValid(e,r)?this.getPartOfToken(e,1,t):{}:{}}getSignatureFromToken(e,t,r){return this.tokenIsValid(e,r)?this.getPartOfToken(e,2,t):{}}getPartOfToken(e,t,r){let i=this.extractPartOfToken(e,t);if(r)return i;let n=this.urlBase64Decode(i);return JSON.parse(n)}urlBase64Decode(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw Error("Illegal base64url string!")}let r=typeof this.document.defaultView<"u"?this.document.defaultView?.atob(t):Buffer.from(t,"base64").toString("binary");if(!r)return"";try{return decodeURIComponent(r.split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join(""))}catch{return r}}tokenIsValid(e,t){return e?e.includes(".")?e.split(".").length!==Ge?(this.loggerService.logError(t,`token '${e}' is not valid --> token has to have exactly ${Ge-1} dots`),!1):!0:(this.loggerService.logError(t,`token '${e}' is not valid --> no dots included`),!1):(this.loggerService.logError(t,`token '${e}' is not valid --> token falsy`),!1)}extractPartOfToken(e,t){return e.split(".")[t]}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),me=(()=>{class s{constructor(){this.document=o(P)}getCrypto(){return this.document.defaultView?.crypto||this.document.defaultView?.msCrypto}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Et=(()=>{class s{constructor(){this.cryptoService=o(me)}importVerificationKey(e,t){return this.cryptoService.getCrypto().subtle.importKey("jwk",e,t,!1,["verify"])}verifyKey(e,t,r,i){return this.cryptoService.getCrypto().subtle.verify(e,t,r,new TextEncoder().encode(i))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),rt=(()=>{class s{constructor(){this.cryptoService=o(me)}generateCodeChallenge(e){return this.calcHash(e).pipe(w(t=>this.base64UrlEncode(t)))}generateAtHash(e,t){return this.calcHash(e,t).pipe(w(r=>{let i=r.substr(0,r.length/2);return btoa(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}))}calcHash(e,t="SHA-256"){let r=new TextEncoder().encode(e);return se(this.cryptoService.getCrypto().subtle.digest(t,r)).pipe(w(i=>{let n=i,a=Array.from(new Uint8Array(n));return this.toHashString(a)}))}toHashString(e){let t="";for(let r of e)t+=String.fromCharCode(r);return t}base64UrlEncode(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();function bt(s){switch(s.charAt(0)){case"R":return{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"};case"E":return s.includes("256")?{name:"ECDSA",hash:"SHA-256"}:s.includes("384")?{name:"ECDSA",hash:"SHA-384"}:null;default:return null}}function At(s){switch(s.charAt(0)){case"R":return"RSA";case"E":return"EC";default:throw new Error("Cannot infer kty from alg: "+s)}}function Ct(s){switch(s.charAt(0)){case"R":return s.includes("256")?{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"}:s.includes("384")?{name:"RSASSA-PKCS1-v1_5",hash:"SHA-384"}:s.includes("512")?{name:"RSASSA-PKCS1-v1_5",hash:"SHA-512"}:null;case"E":return s.includes("256")?{name:"ECDSA",namedCurve:"P-256"}:s.includes("384")?{name:"ECDSA",namedCurve:"P-384"}:null;default:return null}}var ue=(()=>{class s{constructor(){this.keyAlgorithms=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","PS256","PS384","PS512"],this.tokenHelperService=o(he),this.loggerService=o(S),this.jwkExtractor=o(tt),this.jwkWindowCryptoService=o(Et),this.jwtWindowCryptoService=o(rt)}static{this.refreshTokenNoncePlaceholder="--RefreshToken--"}hasIdTokenExpired(e,t,r){let i=this.tokenHelperService.getPayloadFromToken(e,!1,t);return!this.validateIdTokenExpNotExpired(i,t,r)}validateIdTokenExpNotExpired(e,t,r){let i=this.tokenHelperService.getTokenExpirationDate(e);if(r=r||0,!i)return!1;let n=i.valueOf(),a=this.calculateNowWithOffset(r),c=n>a;return this.loggerService.logDebug(t,`Has idToken expired: ${!c} --> expires in ${this.millisToMinutesAndSeconds(n-a)} , ${new Date(n).toLocaleTimeString()} > ${new Date(a).toLocaleTimeString()}`),c}validateAccessTokenNotExpired(e,t,r){if(!e)return!0;r=r||0;let i=e.valueOf(),n=this.calculateNowWithOffset(r),a=i>n;return this.loggerService.logDebug(t,`Has accessToken expired: ${!a} --> expires in ${this.millisToMinutesAndSeconds(i-n)} , ${new Date(i).toLocaleTimeString()} > ${new Date(n).toLocaleTimeString()}`),a}validateRequiredIdToken(e,t){let r=!0;return Object.prototype.hasOwnProperty.call(e,"iss")||(r=!1,this.loggerService.logWarning(t,"iss is missing, this is required in the id_token")),Object.prototype.hasOwnProperty.call(e,"sub")||(r=!1,this.loggerService.logWarning(t,"sub is missing, this is required in the id_token")),Object.prototype.hasOwnProperty.call(e,"aud")||(r=!1,this.loggerService.logWarning(t,"aud is missing, this is required in the id_token")),Object.prototype.hasOwnProperty.call(e,"exp")||(r=!1,this.loggerService.logWarning(t,"exp is missing, this is required in the id_token")),Object.prototype.hasOwnProperty.call(e,"iat")||(r=!1,this.loggerService.logWarning(t,"iat is missing, this is required in the id_token")),r}validateIdTokenIatMaxOffset(e,t,r,i){if(r)return!0;if(!Object.prototype.hasOwnProperty.call(e,"iat"))return!1;let n=new Date(0);n.setUTCSeconds(e.iat),t=t||0;let c=new Date(new Date().toUTCString()).valueOf()-n.valueOf(),l=t*1e3;return this.loggerService.logDebug(i,`validate id token iat max offset ${c} < ${l}`),c>0?c<l:-c<l}validateIdTokenNonce(e,t,r,i){return!((e.nonce===void 0||r)&&t===s.refreshTokenNoncePlaceholder)&&e.nonce!==t?(this.loggerService.logDebug(i,"Validate_id_token_nonce failed, dataIdToken.nonce: "+e.nonce+" local_nonce:"+t),!1):!0}validateIdTokenIss(e,t,r){return e.iss!==t?(this.loggerService.logDebug(r,"Validate_id_token_iss failed, dataIdToken.iss: "+e.iss+" authWellKnownEndpoints issuer:"+t),!1):!0}validateIdTokenAud(e,t,r){return Array.isArray(e.aud)?e.aud.includes(t)?!0:(this.loggerService.logDebug(r,"Validate_id_token_aud array failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1):e.aud!==t?(this.loggerService.logDebug(r,"Validate_id_token_aud failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1):!0}validateIdTokenAzpExistsIfMoreThanOneAud(e){return e?!(Array.isArray(e.aud)&&e.aud.length>1&&!e.azp):!1}validateIdTokenAzpValid(e,t){return e?.azp?e.azp===t:!0}validateStateFromHashCallback(e,t,r){return e!==t?(this.loggerService.logDebug(r,"ValidateStateFromHashCallback failed, state: "+e+" local_state:"+t),!1):!0}validateSignatureIdToken(e,t,r){if(!e)return d(!0);if(!t||!t.keys)return d(!1);let i=this.tokenHelperService.getHeaderFromToken(e,!1,r);if(Object.keys(i).length===0&&i.constructor===Object)return this.loggerService.logWarning(r,"id token has no header data"),d(!1);let n=i.kid,a=i.alg,c=t.keys,l,h;if(!this.keyAlgorithms.includes(a))return this.loggerService.logWarning(r,"alg not supported",a),d(!1);let f=At(a),k="sig";try{l=n?this.jwkExtractor.extractJwk(c,{kid:n,kty:f,use:k},!1):this.jwkExtractor.extractJwk(c,{kty:f,use:k},!1),l.length===0&&(l=n?this.jwkExtractor.extractJwk(c,{kid:n,kty:f}):this.jwkExtractor.extractJwk(c,{kty:f})),h=l[0]}catch(U){return this.loggerService.logError(r,U),d(!1)}let E=Ct(a),p=this.tokenHelperService.getSigningInputFromToken(e,!0,r),H=this.tokenHelperService.getSignatureFromToken(e,!0,r);return se(this.jwkWindowCryptoService.importVerificationKey(h,E)).pipe(V(U=>{let x=_e.parse(H,{loose:!0}),G=bt(a);return se(this.jwkWindowCryptoService.verifyKey(G,U,x,p))}),F(U=>{U||this.loggerService.logWarning(r,"incorrect Signature, validation failed for id_token")}))}validateIdTokenAtHash(e,t,r,i){this.loggerService.logDebug(i,"at_hash from the server:"+t);let n="SHA-256";return r.includes("384")?n="SHA-384":r.includes("512")&&(n="SHA-512"),this.jwtWindowCryptoService.generateAtHash(""+e,n).pipe(V(a=>(this.loggerService.logDebug(i,"at_hash client validation not decoded:"+a),a===t?d(!0):this.jwtWindowCryptoService.generateAtHash(""+decodeURIComponent(e),n).pipe(w(c=>(this.loggerService.logDebug(i,"-gen access--"+a),c===t))))))}millisToMinutesAndSeconds(e){let t=Math.floor(e/6e4),r=(e%6e4/1e3).toFixed(0);return t+":"+(+r<10?"0":"")+r}calculateNowWithOffset(e){return new Date(new Date().toUTCString()).valueOf()+e*1e3}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Tt={isAuthenticated:!1,allConfigsAuthenticated:[]},W=(()=>{class s{constructor(){this.storagePersistenceService=o(b),this.loggerService=o(S),this.publicEventsService=o(j),this.tokenValidationService=o(ue),this.authenticatedInternal$=new re(Tt)}get authenticated$(){return this.authenticatedInternal$.asObservable().pipe(Me())}setAuthenticatedAndFireEvent(e){let t=this.composeAuthenticatedResult(e);this.authenticatedInternal$.next(t)}setUnauthenticatedAndFireEvent(e,t){this.storagePersistenceService.resetAuthStateInStorage(e);let r=this.composeUnAuthenticatedResult(t);this.authenticatedInternal$.next(r)}updateAndPublishAuthState(e){this.publicEventsService.fireEvent(C.NewAuthenticationResult,e)}setAuthorizationData(e,t,r,i){this.loggerService.logDebug(r,`storing the accessToken '${e}'`),this.storagePersistenceService.write("authzData",e,r),this.persistAccessTokenExpirationTime(t,r),this.setAuthenticatedAndFireEvent(i)}getAccessToken(e){if(!e||!this.isAuthenticated(e))return"";let t=this.storagePersistenceService.getAccessToken(e);return this.decodeURIComponentSafely(t)}getIdToken(e){if(!e||!this.isAuthenticated(e))return"";let t=this.storagePersistenceService.getIdToken(e);return this.decodeURIComponentSafely(t)}getRefreshToken(e){if(!e||!this.isAuthenticated(e))return"";let t=this.storagePersistenceService.getRefreshToken(e);return this.decodeURIComponentSafely(t)}getAuthenticationResult(e){return!e||!this.isAuthenticated(e)?null:this.storagePersistenceService.getAuthenticationResult(e)}areAuthStorageTokensValid(e){return!e||!this.isAuthenticated(e)?!1:this.hasIdTokenExpiredAndRenewCheckIsEnabled(e)?(this.loggerService.logDebug(e,"persisted idToken is expired"),!1):this.hasAccessTokenExpiredIfExpiryExists(e)?(this.loggerService.logDebug(e,"persisted accessToken is expired"),!1):(this.loggerService.logDebug(e,"persisted idToken and accessToken are valid"),!0)}hasIdTokenExpiredAndRenewCheckIsEnabled(e){let{renewTimeBeforeTokenExpiresInSeconds:t,triggerRefreshWhenIdTokenExpired:r,disableIdTokenValidation:i}=e;if(!r||i)return!1;let n=this.storagePersistenceService.getIdToken(e),a=this.tokenValidationService.hasIdTokenExpired(n,e,t);return a&&this.publicEventsService.fireEvent(C.IdTokenExpired,a),a}hasAccessTokenExpiredIfExpiryExists(e){let{renewTimeBeforeTokenExpiresInSeconds:t}=e,r=this.storagePersistenceService.read("access_token_expires_at",e),n=!this.tokenValidationService.validateAccessTokenNotExpired(r,e,t);return n&&this.publicEventsService.fireEvent(C.TokenExpired,n),n}isAuthenticated(e){if(!e)return v(()=>new Error("Please provide a configuration before setting up the module")),!1;let t=!!this.storagePersistenceService.getAccessToken(e),r=!!this.storagePersistenceService.getIdToken(e);return t&&r}decodeURIComponentSafely(e){return e?decodeURIComponent(e):""}persistAccessTokenExpirationTime(e,t){if(e?.expires_in){let r=new Date(new Date().toUTCString()).valueOf()+e.expires_in*1e3;this.storagePersistenceService.write("access_token_expires_at",r,t)}}composeAuthenticatedResult(e){if(e.length===1){let{configId:t}=e[0];return{isAuthenticated:!0,allConfigsAuthenticated:[{configId:t??"",isAuthenticated:!0}]}}return this.checkAllConfigsIfTheyAreAuthenticated(e)}composeUnAuthenticatedResult(e){if(e.length===1){let{configId:t}=e[0];return{isAuthenticated:!1,allConfigsAuthenticated:[{configId:t??"",isAuthenticated:!1}]}}return this.checkAllConfigsIfTheyAreAuthenticated(e)}checkAllConfigsIfTheyAreAuthenticated(e){let t=e.map(i=>({configId:i.configId??"",isAuthenticated:this.isAuthenticated(i)})),r=t.every(i=>i.isAuthenticated);return{allConfigsAuthenticated:t,isAuthenticated:r}}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),pe="redirect",Pt=(()=>{class s{constructor(){this.storageService=o(b),this.router=o(ae)}checkSavedRedirectRouteAndNavigate(e){if(!e)return;let t=this.getStoredRedirectRoute(e);t!=null&&(this.deleteStoredRedirectRoute(e),this.router.navigateByUrl(t))}saveRedirectRoute(e,t){e&&this.storageService.write(pe,t,e)}getStoredRedirectRoute(e){return this.storageService.read(pe,e)}deleteStoredRedirectRoute(e){this.storageService.remove(pe,e)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),O=(()=>{class s{isCurrentFlowCodeFlow(e){return this.currentFlowIs("code",e)}isCurrentFlowAnyImplicitFlow(e){return this.isCurrentFlowImplicitFlowWithAccessToken(e)||this.isCurrentFlowImplicitFlowWithoutAccessToken(e)}isCurrentFlowCodeFlowWithRefreshTokens(e){if(!e)return!1;let{useRefreshToken:t}=e;return this.isCurrentFlowCodeFlow(e)&&!!t}isCurrentFlowImplicitFlowWithAccessToken(e){return this.currentFlowIs("id_token token",e)}currentFlowIs(e,t){let{responseType:r}=t;return Array.isArray(e)?e.some(i=>r===i):r===e}isCurrentFlowImplicitFlowWithoutAccessToken(e){return this.currentFlowIs("id_token",e)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Ft=(()=>{class s{constructor(){this.loggerService=o(S),this.cryptoService=o(me)}createRandom(e,t){if(e<=0)return"";e>0&&e<7&&(this.loggerService.logWarning(t,`RandomService called with ${e} but 7 chars is the minimum, returning 10 chars`),e=10);let r=e-6,i=new Uint8Array(Math.floor(r/2)),n=this.cryptoService.getCrypto();return n&&n.getRandomValues(i),Array.from(i,this.toHex).join("")+this.randomString(7)}toHex(e){return("0"+e.toString(16)).substr(-2)}randomString(e){let t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=new Uint32Array(e),n=this.cryptoService.getCrypto();if(n){n.getRandomValues(i);for(let a=0;a<e;a++)t+=r[i[a]%r.length]}return t}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),T=(()=>{class s{constructor(){this.loggerService=o(S),this.storagePersistenceService=o(b),this.randomService=o(Ft)}createNonce(e){let t=this.randomService.createRandom(40,e);return this.loggerService.logDebug(e,"Nonce created. nonce:"+t),this.setNonce(t,e),t}setNonce(e,t){this.storagePersistenceService.write("authNonce",e,t)}getAuthStateControl(e){return e?this.storagePersistenceService.read("authStateControl",e):""}setAuthStateControl(e,t){return t?this.storagePersistenceService.write("authStateControl",e,t):!1}getExistingOrCreateAuthStateControl(e){let t=this.storagePersistenceService.read("authStateControl",e);return t||(t=this.randomService.createRandom(40,e),this.storagePersistenceService.write("authStateControl",t,e)),t}setSessionState(e,t){this.storagePersistenceService.write("session_state",e,t)}resetStorageFlowData(e){this.storagePersistenceService.resetStorageFlowData(e)}getCodeVerifier(e){return this.storagePersistenceService.read("codeVerifier",e)}createCodeVerifier(e){let t=this.randomService.createRandom(67,e);return this.storagePersistenceService.write("codeVerifier",t,e),t}isCodeFlowInProgress(e){return!!this.storagePersistenceService.read("storageCodeFlowInProgress",e)}setCodeFlowInProgress(e){this.storagePersistenceService.write("storageCodeFlowInProgress",!0,e)}resetCodeFlowInProgress(e){this.storagePersistenceService.write("storageCodeFlowInProgress",!1,e)}isSilentRenewRunning(e){let{configId:t,silentRenewTimeoutInSeconds:r}=e,i=this.getSilentRenewRunningStorageEntry(e);if(!i||i.state==="not-running")return!1;let n=(r??0)*1e3,a=Date.parse(i.dateOfLaunchedProcessUtc),c=Date.parse(new Date().toISOString());return Math.abs(c-a)>n?(this.loggerService.logDebug(e,"silent renew process is probably stuck, state will be reset.",t),this.resetSilentRenewRunning(e),!1):i.state==="running"}setSilentRenewRunning(e){let t={state:"running",dateOfLaunchedProcessUtc:new Date().toISOString()};this.storagePersistenceService.write("storageSilentRenewRunning",JSON.stringify(t),e)}resetSilentRenewRunning(e){e&&this.storagePersistenceService.write("storageSilentRenewRunning","",e)}getSilentRenewRunningStorageEntry(e){let t=this.storagePersistenceService.read("storageSilentRenewRunning",e);return t?JSON.parse(t):{dateOfLaunchedProcessUtc:"",state:"not-running"}}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),ke=class{encodeKey(u){return encodeURIComponent(u)}encodeValue(u){return encodeURIComponent(u)}decodeKey(u){return decodeURIComponent(u)}decodeValue(u){return decodeURIComponent(u)}},Ut=["code","state","token","id_token"],Wt="auth0.com",M=(()=>{class s{constructor(){this.loggerService=o(S),this.flowsDataService=o(T),this.flowHelper=o(O),this.storagePersistenceService=o(b),this.jwtWindowCryptoService=o(rt)}getUrlParameter(e,t){if(!e||!t)return"";t=t.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");let i=new RegExp("[\\?&#]"+t+"=([^&#]*)").exec(e);return i===null?"":decodeURIComponent(i[1])}getUrlWithoutQueryParameters(e){let t=new URL(e.toString()),r=[];for(let i of t.searchParams.keys())r.push(i);return r.forEach(i=>{t.searchParams.delete(i)}),t}queryParametersExist(e,t){let r=!0;return e.forEach((i,n)=>{t.has(n)||(r=!1)}),r}isCallbackFromSts(e,t){if(t&&t.checkRedirectUrlWhenCheckingIfIsCallback){let r=new URL(e),i=this.getRedirectUrl(t);if(!i)return this.loggerService.logError(t,"UrlService.isCallbackFromSts: could not get redirectUrl from config, was: ",i),!1;let n=new URL(i),a=this.getUrlWithoutQueryParameters(n).toString(),c=this.getUrlWithoutQueryParameters(r).toString(),l=this.queryParametersExist(n.searchParams,r.searchParams);if(a!==c||!l)return this.loggerService.logDebug(t,"UrlService.isCallbackFromSts: configured redirectUrl does not match with the current url"),!1}return Ut.some(r=>!!this.getUrlParameter(e,r))}getRefreshSessionSilentRenewUrl(e,t){return this.flowHelper.isCurrentFlowCodeFlow(e)?this.createUrlCodeFlowWithSilentRenew(e,t):d(this.createUrlImplicitFlowWithSilentRenew(e,t))}getAuthorizeParUrl(e,t){let r=this.storagePersistenceService.read("authWellKnownEndPoints",t);if(!r)return this.loggerService.logError(t,"authWellKnownEndpoints is undefined"),null;let i=r.authorizationEndpoint;if(!i)return this.loggerService.logError(t,`Can not create an authorize URL when authorizationEndpoint is '${i}'`),null;let{clientId:n}=t;if(!n)return this.loggerService.logError(t,"getAuthorizeParUrl could not add clientId because it was: ",n),null;let a=i.split("?"),c=a[0],l=a[1],h=this.createHttpParams(l);return h=h.set("request_uri",e),h=h.append("client_id",n),`${c}?${h}`}getAuthorizeUrl(e,t){return e?this.flowHelper.isCurrentFlowCodeFlow(e)?this.createUrlCodeFlowAuthorize(e,t):d(this.createUrlImplicitFlowAuthorize(e,t)||""):d(null)}getEndSessionEndpoint(e){let r=this.storagePersistenceService.read("authWellKnownEndPoints",e)?.endSessionEndpoint;if(!r)return{url:"",existingParams:""};let i=r.split("?"),n=i[0],a=i[1]??"";return{url:n,existingParams:a}}getEndSessionUrl(e,t){if(!e)return null;let r=this.storagePersistenceService.getIdToken(e),{customParamsEndSessionRequest:i}=e,n=y(y({},i),t);return this.createEndSessionUrl(r,e,n)}createRevocationEndpointBodyAccessToken(e,t){let r=this.getClientId(t);if(!r)return null;let i=this.createHttpParams();return i=i.set("client_id",r),i=i.set("token",e),i=i.set("token_type_hint","access_token"),i.toString()}createRevocationEndpointBodyRefreshToken(e,t){let r=this.getClientId(t);if(!r)return null;let i=this.createHttpParams();return i=i.set("client_id",r),i=i.set("token",e),i=i.set("token_type_hint","refresh_token"),i.toString()}getRevocationEndpointUrl(e){let r=this.storagePersistenceService.read("authWellKnownEndPoints",e)?.revocationEndpoint;return r?r.split("?")[0]:null}createBodyForCodeFlowCodeRequest(e,t,r){let i=this.getClientId(t);if(!i)return null;let n=this.createHttpParams();if(n=n.set("grant_type","authorization_code"),n=n.set("client_id",i),!t.disablePkce){let l=this.flowsDataService.getCodeVerifier(t);if(!l)return this.loggerService.logError(t,"CodeVerifier is not set ",l),null;n=n.set("code_verifier",l)}n=n.set("code",e),r&&(n=this.appendCustomParams(y({},r),n));let a=this.getSilentRenewUrl(t);if(this.flowsDataService.isSilentRenewRunning(t)&&a)return n=n.set("redirect_uri",a),n.toString();let c=this.getRedirectUrl(t);return c?(n=n.set("redirect_uri",c),n.toString()):null}createBodyForCodeFlowRefreshTokensRequest(e,t,r){let i=this.getClientId(t);if(!i)return null;let n=this.createHttpParams();return n=n.set("grant_type","refresh_token"),n=n.set("client_id",i),n=n.set("refresh_token",e),r&&(n=this.appendCustomParams(y({},r),n)),n.toString()}createBodyForParCodeFlowRequest(e,t){let r=this.getRedirectUrl(e,t);if(!r)return d(null);let i=this.flowsDataService.getExistingOrCreateAuthStateControl(e),n=this.flowsDataService.createNonce(e);this.loggerService.logDebug(e,"Authorize created. adding myautostate: "+i);let a=this.flowsDataService.createCodeVerifier(e);return this.jwtWindowCryptoService.generateCodeChallenge(a).pipe(w(c=>{let{clientId:l,responseType:h,scope:f,hdParam:k,customParamsAuthRequest:E}=e,p=this.createHttpParams("");return p=p.set("client_id",l??""),p=p.append("redirect_uri",r),p=p.append("response_type",h??""),p=p.append("scope",f??""),p=p.append("nonce",n),p=p.append("state",i),p=p.append("code_challenge",c),p=p.append("code_challenge_method","S256"),k&&(p=p.append("hd",k)),E&&(p=this.appendCustomParams(y({},E),p)),t?.customParams&&(p=this.appendCustomParams(y({},t.customParams),p)),p.toString()}))}getPostLogoutRedirectUrl(e){let{postLogoutRedirectUri:t}=e;return t||(this.loggerService.logError(e,"could not get postLogoutRedirectUri, was: ",t),null)}createEndSessionUrl(e,t,r){if(this.isAuth0Endpoint(t))return this.composeAuth0Endpoint(t);let{url:i,existingParams:n}=this.getEndSessionEndpoint(t);if(!i)return null;let a=this.createHttpParams(n);e&&(a=a.set("id_token_hint",e));let c=this.getPostLogoutRedirectUrl(t);return c&&(a=a.append("post_logout_redirect_uri",c)),r&&(a=this.appendCustomParams(y({},r),a)),`${i}?${a}`}createAuthorizeUrl(e,t,r,i,n,a,c){let h=this.storagePersistenceService.read("authWellKnownEndPoints",n)?.authorizationEndpoint;if(!h)return this.loggerService.logError(n,`Can not create an authorize URL when authorizationEndpoint is '${h}'`),"";let{clientId:f,responseType:k,scope:E,hdParam:p,customParamsAuthRequest:H}=n;if(!f)return this.loggerService.logError(n,"createAuthorizeUrl could not add clientId because it was: ",f),"";if(!k)return this.loggerService.logError(n,"createAuthorizeUrl could not add responseType because it was: ",k),"";if(!E)return this.loggerService.logError(n,"createAuthorizeUrl could not add scope because it was: ",E),"";let U=h.split("?"),x=U[0],G=U[1],m=this.createHttpParams(G);m=m.set("client_id",f),m=m.append("redirect_uri",t),m=m.append("response_type",k),m=m.append("scope",E),m=m.append("nonce",r),m=m.append("state",i),this.flowHelper.isCurrentFlowCodeFlow(n)&&(m=m.append("code_challenge",e),m=m.append("code_challenge_method","S256"));let Ce=y(y({},H),c);return Object.keys(Ce).length>0&&(m=this.appendCustomParams(y({},Ce),m)),a&&(m=this.overWriteParam(m,"prompt",a)),p&&(m=m.append("hd",p)),`${x}?${m}`}createUrlImplicitFlowWithSilentRenew(e,t){let r=this.flowsDataService.getExistingOrCreateAuthStateControl(e),i=this.flowsDataService.createNonce(e),n=this.getSilentRenewUrl(e);return n?(this.loggerService.logDebug(e,"RefreshSession created. adding myautostate: ",r),this.storagePersistenceService.read("authWellKnownEndPoints",e)?this.createAuthorizeUrl("",n,i,r,e,"none",t):(this.loggerService.logError(e,"authWellKnownEndpoints is undefined"),null)):null}createUrlCodeFlowWithSilentRenew(e,t){let r=this.flowsDataService.getExistingOrCreateAuthStateControl(e),i=this.flowsDataService.createNonce(e);this.loggerService.logDebug(e,"RefreshSession created. adding myautostate: "+r);let n=this.flowsDataService.createCodeVerifier(e);return this.jwtWindowCryptoService.generateCodeChallenge(n).pipe(w(a=>{let c=this.getSilentRenewUrl(e);return c?this.storagePersistenceService.read("authWellKnownEndPoints",e)?this.createAuthorizeUrl(a,c,i,r,e,"none",t):(this.loggerService.logWarning(e,"authWellKnownEndpoints is undefined"),""):""}))}createUrlImplicitFlowAuthorize(e,t){let r=this.flowsDataService.getExistingOrCreateAuthStateControl(e),i=this.flowsDataService.createNonce(e);this.loggerService.logDebug(e,"Authorize created. adding myautostate: "+r);let n=this.getRedirectUrl(e,t);if(!n)return null;if(this.storagePersistenceService.read("authWellKnownEndPoints",e)){let{customParams:c}=t||{};return this.createAuthorizeUrl("",n,i,r,e,"",c)}return this.loggerService.logError(e,"authWellKnownEndpoints is undefined"),null}createUrlCodeFlowAuthorize(e,t){let r=this.flowsDataService.getExistingOrCreateAuthStateControl(e),i=this.flowsDataService.createNonce(e);this.loggerService.logDebug(e,"Authorize created. adding myautostate: "+r);let n=this.getRedirectUrl(e,t);return n?this.getCodeChallenge(e).pipe(w(a=>{if(this.storagePersistenceService.read("authWellKnownEndPoints",e)){let{customParams:l}=t||{};return this.createAuthorizeUrl(a,n,i,r,e,"",l)}return this.loggerService.logError(e,"authWellKnownEndpoints is undefined"),""})):d(null)}getCodeChallenge(e){if(e.disablePkce)return d("");let t=this.flowsDataService.createCodeVerifier(e);return this.jwtWindowCryptoService.generateCodeChallenge(t)}getRedirectUrl(e,t){let{redirectUrl:r}=e;return t?.redirectUrl&&(r=t.redirectUrl),r||(this.loggerService.logError(e,"could not get redirectUrl, was: ",r),null)}getSilentRenewUrl(e){let{silentRenewUrl:t}=e;return t||(this.loggerService.logError(e,"could not get silentRenewUrl, was: ",t),null)}getClientId(e){let{clientId:t}=e;return t||(this.loggerService.logError(e,"could not get clientId, was: ",t),null)}appendCustomParams(e,t){for(let[r,i]of Object.entries(y({},e)))t=t.append(r,i.toString());return t}overWriteParam(e,t,r){return e.set(t,r)}createHttpParams(e){return e=e??"",new oe({fromString:e,encoder:new ke})}isAuth0Endpoint(e){let{authority:t,useCustomAuth0Domain:r}=e;return t?t.endsWith(Wt)||!!r:!1}composeAuth0Endpoint(e){let{authority:t,clientId:r}=e,i=this.getPostLogoutRedirectUrl(e);return`${t}/v2/logout?client_id=${r}&returnTo=${i}`}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Mt=(()=>{class s{constructor(){this.http=o(qe)}get(e,t){return this.http.get(e,t)}post(e,t,r){return this.http.post(e,t,r)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Ot="ngsw-bypass",N=(()=>{class s{constructor(){this.httpClient=o(Mt)}get(e,t,r){let i=this.prepareHeaders(r),n=this.prepareParams(t);return this.httpClient.get(e,{headers:i,params:n})}post(e,t,r,i){let n=i||this.prepareHeaders(),a=this.prepareParams(r);return this.httpClient.post(e??"",t,{headers:n,params:a})}prepareHeaders(e){let t=new q;return t=t.set("Accept","application/json"),e&&(t=t.set("Authorization","Bearer "+decodeURIComponent(e))),t}prepareParams(e){let t=new oe,{ngswBypass:r}=e;return r&&(t=t.set(Ot,"")),t}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),st=s=>!!s&&s instanceof ze&&(s.error instanceof ProgressEvent&&s.error.type==="error"||s.status===0&&!!s.error),$t=(()=>{class s{constructor(){this.urlService=o(M),this.loggerService=o(S),this.tokenValidationService=o(ue),this.flowsDataService=o(T),this.storagePersistenceService=o(b),this.dataService=o(N)}codeFlowCallback(e,t){let r=this.urlService.getUrlParameter(e,"code"),i=this.urlService.getUrlParameter(e,"state"),n=this.urlService.getUrlParameter(e,"session_state");return i?r?(this.loggerService.logDebug(t,"running validation for callback",e),d({code:r,refreshToken:"",state:i,sessionState:n,authResult:null,isRenewProcess:!1,jwtKeys:null,validationResult:null,existingIdToken:null})):(this.loggerService.logDebug(t,"no code in url"),v(()=>new Error("no code in url"))):(this.loggerService.logDebug(t,"no state in url"),v(()=>new Error("no state in url")))}codeFlowCodeRequest(e,t){let r=this.flowsDataService.getAuthStateControl(t);if(!this.tokenValidationService.validateStateFromHashCallback(e.state,r,t))return v(()=>new Error("codeFlowCodeRequest incorrect state"));let a=this.storagePersistenceService.read("authWellKnownEndPoints",t)?.tokenEndpoint;if(!a)return v(()=>new Error("Token Endpoint not defined"));let c=new q;c=c.set("Content-Type","application/x-www-form-urlencoded");let l=this.urlService.createBodyForCodeFlowCodeRequest(e.code,t,t?.customParamsCodeRequest);return this.dataService.post(a,l,t,c).pipe(D(h=>{if(h){let f=fe(y({},h),{state:e.state,session_state:e.sessionState});e.authResult=f}return d(e)}),ne(h=>this.handleRefreshRetry(h,t)),A(h=>{let{authority:f}=t,k=`OidcService code request ${f}`;return this.loggerService.logError(t,k,h),v(()=>new Error(k))}))}handleRefreshRetry(e,t){return e.pipe(V(r=>{if(st(r)){let{authority:i,refreshTokenRetryInSeconds:n}=t,a=`OidcService code request ${i} - no internet connection`;return this.loggerService.logWarning(t,a,r),ie((n??0)*1e3)}return v(()=>r)}))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),R=(function(s){return s.NotSet="NotSet",s.StatesDoNotMatch="StatesDoNotMatch",s.SignatureFailed="SignatureFailed",s.IncorrectNonce="IncorrectNonce",s.RequiredPropertyMissing="RequiredPropertyMissing",s.MaxOffsetExpired="MaxOffsetExpired",s.IssDoesNotMatchIssuer="IssDoesNotMatchIssuer",s.NoAuthWellKnownEndPoints="NoAuthWellKnownEndPoints",s.IncorrectAud="IncorrectAud",s.IncorrectIdTokenClaimsAfterRefresh="IncorrectIdTokenClaimsAfterRefresh",s.IncorrectAzp="IncorrectAzp",s.TokenExpired="TokenExpired",s.IncorrectAtHash="IncorrectAtHash",s.Ok="Ok",s.LoginRequired="LoginRequired",s.SecureTokenServerError="SecureTokenServerError",s})(R||{}),Ht={userData:null,allUserData:[]},B=(()=>{class s{constructor(){this.userDataInternal$=new re(Ht),this.loggerService=o(S),this.tokenHelperService=o(he),this.flowHelper=o(O),this.oidcDataService=o(N),this.storagePersistenceService=o(b),this.eventService=o(j)}get userData$(){return this.userDataInternal$.asObservable()}getAndPersistUserDataInStore(e,t,r=!1,i,n){i=i||this.storagePersistenceService.getIdToken(e),n=n||this.tokenHelperService.getPayloadFromToken(i,!1,e);let a=this.getUserDataFromStore(e),c=!!a,l=this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(e),h=this.flowHelper.isCurrentFlowCodeFlow(e),f=this.storagePersistenceService.getAccessToken(e);if(!(l||h))return this.loggerService.logDebug(e,`authCallback idToken flow with accessToken ${f}`),this.setUserDataToStore(n,e,t),d(n);let{renewUserInfoAfterTokenRenew:k}=e;return!r||k||!c?this.getUserDataOidcFlowAndSave(n.sub,e,t).pipe(D(E=>(this.loggerService.logDebug(e,"Received user data: ",E),E?(this.loggerService.logDebug(e,"accessToken: ",f),d(E)):v(()=>new Error("Received no user data, request failed"))))):d(a)}getUserDataFromStore(e){return e?this.storagePersistenceService.read("userData",e)||null:v(()=>new Error("Please provide a configuration before setting up the module"))}publishUserDataIfExists(e,t){let r=this.getUserDataFromStore(e);r&&this.fireUserDataEvent(e,t,r)}setUserDataToStore(e,t,r){this.storagePersistenceService.write("userData",e,t),this.fireUserDataEvent(t,r,e)}resetUserDataInStore(e,t){this.storagePersistenceService.remove("userData",e),this.fireUserDataEvent(e,t,null)}getUserDataOidcFlowAndSave(e,t,r){return this.getIdentityUserData(t).pipe(w(i=>this.validateUserDataSubIdToken(t,e,i?.sub)?(this.setUserDataToStore(i,t,r),i):(this.loggerService.logWarning(t,"User data sub does not match sub in id_token, resetting"),this.resetUserDataInStore(t,r),null)))}getIdentityUserData(e){let t=this.storagePersistenceService.getAccessToken(e),r=this.storagePersistenceService.read("authWellKnownEndPoints",e);if(!r)return this.loggerService.logWarning(e,"init check session: authWellKnownEndpoints is undefined"),v(()=>new Error("authWellKnownEndpoints is undefined"));let i=r.userInfoEndpoint;return i?this.oidcDataService.get(i,e,t).pipe(L(2)):(this.loggerService.logError(e,"init check session: authWellKnownEndpoints.userinfo_endpoint is undefined; set auto_userinfo = false in config"),v(()=>new Error("authWellKnownEndpoints.userinfo_endpoint is undefined")))}validateUserDataSubIdToken(e,t,r){return!t||!r?!1:t.toString()!==r.toString()?(this.loggerService.logDebug(e,"validateUserDataSubIdToken failed",t,r),!1):!0}fireUserDataEvent(e,t,r){let i=this.composeSingleOrMultipleUserDataObject(e,t,r);this.userDataInternal$.next(i);let{configId:n}=e;this.eventService.fireEvent(C.UserDataChanged,{configId:n,userData:r})}composeSingleOrMultipleUserDataObject(e,t,r){if(!(t.length>1)){let{configId:a}=e;return this.composeSingleUserDataResult(a??"",r)}return{userData:null,allUserData:t.map(a=>{let c=e.configId??"",l=a.configId??"";if(this.currentConfigIsToUpdate(c,a))return{configId:l,userData:r};let h=this.storagePersistenceService.read("userData",a)||null;return{configId:l,userData:h}})}}composeSingleUserDataResult(e,t){return{userData:t,allUserData:[{configId:e,userData:t}]}}currentConfigIsToUpdate(e,t){return t.configId===e}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),$=(()=>{class s{constructor(){this.loggerService=o(S),this.userService=o(B),this.flowsDataService=o(T),this.authStateService=o(W)}resetAuthorizationData(e,t){e&&(this.userService.resetUserDataInStore(e,t),this.flowsDataService.resetStorageFlowData(e),this.authStateService.setUnauthenticatedAndFireEvent(e,t),this.loggerService.logDebug(e,"Local Login information cleaned up and event fired"))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),xt=(()=>{class s{constructor(){this.loggerService=o(S),this.storagePersistenceService=o(b),this.dataService=o(N)}getSigningKeys(e){let r=this.storagePersistenceService.read("authWellKnownEndPoints",e)?.jwksUri;if(!r){let i=`getSigningKeys: authWellKnownEndpoints.jwksUri is: '${r}'`;return this.loggerService.logWarning(e,i),v(()=>new Error(i))}return this.loggerService.logDebug(e,"Getting signinkeys from ",r),this.dataService.get(r,e).pipe(L(2),A(i=>this.handleErrorGetSigningKeys(i,e)))}handleErrorGetSigningKeys(e,t){let r="";if(e instanceof Le){let i=e.body||{},n=JSON.stringify(i),{status:a,statusText:c}=e;r=`${a||""} - ${c||""} ${n||""}`}else{let{message:i}=e;r=i||`${e}`}return this.loggerService.logError(t,r),v(()=>new Error(r))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Qe="jwtKeys",Vt=(()=>{class s{constructor(){this.loggerService=o(S),this.authStateService=o(W),this.flowsDataService=o(T),this.signInKeyDataService=o(xt),this.storagePersistenceService=o(b),this.resetAuthDataService=o($),this.document=o(P)}callbackHistoryAndResetJwtKeys(e,t,r){let i=y({},e.authResult);if(!this.responseHasIdToken(e)){let n=this.storagePersistenceService.getIdToken(t);i=fe(y({},i),{id_token:n})}if(this.storagePersistenceService.write("authnResult",i,t),t.allowUnsafeReuseRefreshToken&&e.authResult?.refresh_token&&this.storagePersistenceService.write("reusable_refresh_token",e.authResult.refresh_token,t),this.historyCleanUpTurnedOn(t)&&!e.isRenewProcess?this.resetBrowserHistory():this.loggerService.logDebug(t,"history clean up inactive"),e.authResult?.error){let n=`AuthCallback AuthResult came with error: ${e.authResult.error}`;return this.loggerService.logDebug(t,n),this.resetAuthDataService.resetAuthorizationData(t,r),this.flowsDataService.setNonce("",t),this.handleResultErrorFromCallback(e.authResult,e.isRenewProcess,t.configId),v(()=>new Error(n))}return this.loggerService.logDebug(t,`AuthResult '${JSON.stringify(e.authResult,null,2)}'.
      AuthCallback created, begin token validation`),this.signInKeyDataService.getSigningKeys(t).pipe(F(n=>this.storeSigningKeys(n,t)),A(n=>{let a=this.readSigningKeys(t);return a?(this.loggerService.logWarning(t,"Failed to retrieve signing keys, fallback to stored keys"),d(a)):v(()=>new Error(n))}),D(n=>{if(n)return e.jwtKeys=n,d(e);let a="Failed to retrieve signing key";return this.loggerService.logWarning(t,a),v(()=>new Error(a))}),A(n=>{let a=`Failed to retrieve signing key with error: ${n}`;return this.loggerService.logWarning(t,a),v(()=>new Error(a))}))}responseHasIdToken(e){return!!e?.authResult?.id_token}handleResultErrorFromCallback(e,t,r){let i=R.SecureTokenServerError;e&&typeof e=="object"&&"error"in e&&e.error==="login_required"&&(i=R.LoginRequired),this.authStateService.updateAndPublishAuthState({isAuthenticated:!1,validationResult:i,isRenewProcess:t,configId:r})}historyCleanUpTurnedOn(e){let{historyCleanupOff:t}=e;return!t}resetBrowserHistory(){this.document.defaultView?.history.replaceState({},this.document.title,this.document.defaultView.location.origin+this.document.defaultView.location.pathname)}storeSigningKeys(e,t){this.storagePersistenceService.write(Qe,e,t)}readSigningKeys(e){return this.storagePersistenceService.read(Qe,e)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),jt=(()=>{class s{constructor(){this.loggerService=o(S),this.resetAuthDataService=o($),this.flowsDataService=o(T),this.document=o(P)}implicitFlowCallback(e,t,r){let i=this.flowsDataService.isSilentRenewRunning(e);this.loggerService.logDebug(e,"BEGIN callback, no auth data"),i||this.resetAuthDataService.resetAuthorizationData(e,t),r=r||this.document.location.hash.substring(1);let a={code:"",refreshToken:"",state:"",sessionState:null,authResult:r.split("&").reduce((c,l)=>{let h=l.split("=");return c[h.shift()]=h.join("="),c},{}),isRenewProcess:i,jwtKeys:null,validationResult:null,existingIdToken:null};return d(a)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Nt=(()=>{class s{constructor(){this.loggerService=o(S),this.authStateService=o(W),this.flowsDataService=o(T)}refreshSessionWithRefreshTokens(e){let t=this.flowsDataService.getExistingOrCreateAuthStateControl(e);this.loggerService.logDebug(e,"RefreshSession created. Adding myautostate: "+t);let r=this.authStateService.getRefreshToken(e),i=this.authStateService.getIdToken(e);if(r){let n={code:"",refreshToken:r,state:t,sessionState:null,authResult:null,isRenewProcess:!0,jwtKeys:null,validationResult:null,existingIdToken:i};return this.loggerService.logDebug(e,"found refresh code, obtaining new credentials with refresh code"),this.flowsDataService.setNonce(ue.refreshTokenNoncePlaceholder,e),d(n)}else{let n="no refresh token found, please login";return this.loggerService.logError(e,n),v(()=>new Error(n))}}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Kt=(()=>{class s{constructor(){this.urlService=o(M),this.loggerService=o(S),this.dataService=o(N),this.storagePersistenceService=o(b)}refreshTokensRequestTokens(e,t,r){let i=new q;i=i.set("Content-Type","application/x-www-form-urlencoded");let a=this.storagePersistenceService.read("authWellKnownEndPoints",t)?.tokenEndpoint;if(!a)return v(()=>new Error("Token Endpoint not defined"));let c=this.urlService.createBodyForCodeFlowRefreshTokensRequest(e.refreshToken,t,r);return this.dataService.post(a,c,t,i).pipe(D(l=>(this.loggerService.logDebug(t,`token refresh response: ${l}`),l&&(l.state=e.state),e.authResult=l,d(e))),ne(l=>this.handleRefreshRetry(l,t)),A(l=>{let{authority:h}=t,f=`OidcService code request ${h}`;return this.loggerService.logError(t,f,l),v(()=>new Error(f))}))}handleRefreshRetry(e,t){return e.pipe(V(r=>{if(st(r)){let{authority:i,refreshTokenRetryInSeconds:n}=t,a=`OidcService code request ${i} - no internet connection`;return this.loggerService.logWarning(t,a,r),ie((n??0)*1e3)}return v(()=>r)}))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Lt=(()=>{class s{isStringEqualOrNonOrderedArrayEqual(e,t){return this.isNullOrUndefined(e)||this.isNullOrUndefined(t)||this.oneValueIsStringAndTheOtherIsArray(e,t)?!1:this.bothValuesAreStrings(e,t)?e===t:this.arraysHaveEqualContent(e,t)}areEqual(e,t){if(!e||!t)return!1;if(this.bothValuesAreArrays(e,t))return this.arraysStrictEqual(e,t);if(this.bothValuesAreStrings(e,t))return e===t;if(this.bothValuesAreObjects(e,t))return JSON.stringify(e).toLowerCase()===JSON.stringify(t).toLowerCase();if(this.oneValueIsStringAndTheOtherIsArray(e,t)){if(Array.isArray(e)&&this.valueIsString(t))return e[0]===t;if(Array.isArray(t)&&this.valueIsString(e))return t[0]===e}return e===t}oneValueIsStringAndTheOtherIsArray(e,t){return Array.isArray(e)&&this.valueIsString(t)||Array.isArray(t)&&this.valueIsString(e)}bothValuesAreObjects(e,t){return this.valueIsObject(e)&&this.valueIsObject(t)}bothValuesAreStrings(e,t){return this.valueIsString(e)&&this.valueIsString(t)}bothValuesAreArrays(e,t){return Array.isArray(e)&&Array.isArray(t)}valueIsString(e){return typeof e=="string"||e instanceof String}valueIsObject(e){return typeof e=="object"}arraysStrictEqual(e,t){if(e.length!==t.length)return!1;for(let r=e.length;r--;)if(e[r]!==t[r])return!1;return!0}arraysHaveEqualContent(e,t){return e.length!==t.length?!1:e.some(r=>t.includes(r))}isNullOrUndefined(e){return e==null}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),le=class{constructor(u="",e="",t=!1,r={at_hash:""},i=R.NotSet){this.accessToken=u,this.idToken=e,this.authResponseIsValid=t,this.decodedIdToken=r,this.state=i}},zt=(()=>{class s{constructor(){this.storagePersistenceService=o(b),this.tokenValidationService=o(ue),this.tokenHelperService=o(he),this.loggerService=o(S),this.equalityService=o(Lt),this.flowHelper=o(O)}getValidatedStateResult(e,t){let r=!!e.authResult?.error;return!!!e||r?d(new le("","",!1,{})):this.validateState(e,t)}validateState(e,t){let r=new le,i=this.storagePersistenceService.read("authStateControl",t);if(!this.tokenValidationService.validateStateFromHashCallback(e.authResult?.state,i,t))return this.loggerService.logWarning(t,"authCallback incorrect state"),r.state=R.StatesDoNotMatch,this.handleUnsuccessfulValidation(t),d(r);let n=this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(t),a=this.flowHelper.isCurrentFlowCodeFlow(t);if((n||a)&&(r.accessToken=e.authResult?.access_token??""),t.disableIdTokenValidation)return r.state=R.Ok,r.authResponseIsValid=!0,d(r);let l=e.isRenewProcess&&!!e.refreshToken,h=!!e.authResult?.id_token;if(l&&!h)return r.state=R.Ok,r.authResponseIsValid=!0,d(r);if(h){let{clientId:f,issValidationOff:k,maxIdTokenIatOffsetAllowedInSeconds:E,disableIatOffsetValidation:p,ignoreNonceAfterRefresh:H,renewTimeBeforeTokenExpiresInSeconds:U}=t;return r.idToken=e.authResult?.id_token??"",r.decodedIdToken=this.tokenHelperService.getPayloadFromToken(r.idToken,!1,t),this.tokenValidationService.validateSignatureIdToken(r.idToken,e.jwtKeys,t).pipe(V(x=>{if(!x)return this.loggerService.logDebug(t,"authCallback Signature validation failed id_token"),r.state=R.SignatureFailed,this.handleUnsuccessfulValidation(t),d(r);let G=this.storagePersistenceService.read("authNonce",t);if(!this.tokenValidationService.validateIdTokenNonce(r.decodedIdToken,G,!!H,t))return this.loggerService.logWarning(t,"authCallback incorrect nonce, did you call the checkAuth() method multiple times?"),r.state=R.IncorrectNonce,this.handleUnsuccessfulValidation(t),d(r);if(!this.tokenValidationService.validateRequiredIdToken(r.decodedIdToken,t))return this.loggerService.logDebug(t,"authCallback Validation, one of the REQUIRED properties missing from id_token"),r.state=R.RequiredPropertyMissing,this.handleUnsuccessfulValidation(t),d(r);if(!l&&!this.tokenValidationService.validateIdTokenIatMaxOffset(r.decodedIdToken,E??120,!!p,t))return this.loggerService.logWarning(t,"authCallback Validation, iat rejected id_token was issued too far away from the current time"),r.state=R.MaxOffsetExpired,this.handleUnsuccessfulValidation(t),d(r);let m=this.storagePersistenceService.read("authWellKnownEndPoints",t);if(m){if(k)this.loggerService.logDebug(t,"iss validation is turned off, this is not recommended!");else if(!k&&!this.tokenValidationService.validateIdTokenIss(r.decodedIdToken,m.issuer,t))return this.loggerService.logWarning(t,"authCallback incorrect iss does not match authWellKnownEndpoints issuer"),r.state=R.IssDoesNotMatchIssuer,this.handleUnsuccessfulValidation(t),d(r)}else return this.loggerService.logWarning(t,"authWellKnownEndpoints is undefined"),r.state=R.NoAuthWellKnownEndPoints,this.handleUnsuccessfulValidation(t),d(r);return this.tokenValidationService.validateIdTokenAud(r.decodedIdToken,f,t)?this.tokenValidationService.validateIdTokenAzpExistsIfMoreThanOneAud(r.decodedIdToken)?this.tokenValidationService.validateIdTokenAzpValid(r.decodedIdToken,f)?this.isIdTokenAfterRefreshTokenRequestValid(e,r.decodedIdToken,t)?!l&&!this.tokenValidationService.validateIdTokenExpNotExpired(r.decodedIdToken,t,U)?(this.loggerService.logWarning(t,"authCallback id token expired"),r.state=R.TokenExpired,this.handleUnsuccessfulValidation(t),d(r)):this.validateDefault(n,a,r,t,e):(this.loggerService.logWarning(t,"authCallback pre, post id_token claims do not match in refresh"),r.state=R.IncorrectIdTokenClaimsAfterRefresh,this.handleUnsuccessfulValidation(t),d(r)):(this.loggerService.logWarning(t,"authCallback incorrect azp"),r.state=R.IncorrectAzp,this.handleUnsuccessfulValidation(t),d(r)):(this.loggerService.logWarning(t,"authCallback missing azp"),r.state=R.IncorrectAzp,this.handleUnsuccessfulValidation(t),d(r)):(this.loggerService.logWarning(t,"authCallback incorrect aud"),r.state=R.IncorrectAud,this.handleUnsuccessfulValidation(t),d(r))}))}else this.loggerService.logDebug(t,"No id_token found, skipping id_token validation");return this.validateDefault(n,a,r,t,e)}validateDefault(e,t,r,i,n){if(!e&&!t)return r.authResponseIsValid=!0,r.state=R.Ok,this.handleSuccessfulValidation(i),this.handleUnsuccessfulValidation(i),d(r);if(n.authResult?.id_token){let a=this.tokenHelperService.getHeaderFromToken(r.idToken,!1,i);if(t&&!r.decodedIdToken.at_hash)this.loggerService.logDebug(i,"Code Flow active, and no at_hash in the id_token, skipping check!");else return this.tokenValidationService.validateIdTokenAtHash(r.accessToken,r.decodedIdToken.at_hash,a.alg,i).pipe(w(c=>!c||!r.accessToken?(this.loggerService.logWarning(i,"authCallback incorrect at_hash"),r.state=R.IncorrectAtHash,this.handleUnsuccessfulValidation(i),r):(r.authResponseIsValid=!0,r.state=R.Ok,this.handleSuccessfulValidation(i),r)))}return r.authResponseIsValid=!0,r.state=R.Ok,this.handleSuccessfulValidation(i),d(r)}isIdTokenAfterRefreshTokenRequestValid(e,t,r){let{useRefreshToken:i,disableRefreshIdTokenAuthTimeValidation:n}=r;if(!i||!e.existingIdToken)return!0;let a=this.tokenHelperService.getPayloadFromToken(e.existingIdToken,!1,r);return a.iss!==t.iss?(this.loggerService.logDebug(r,`iss do not match: ${a.iss} ${t.iss}`),!1):a.azp!==t.azp?(this.loggerService.logDebug(r,`azp do not match: ${a.azp} ${t.azp}`),!1):a.sub!==t.sub?(this.loggerService.logDebug(r,`sub do not match: ${a.sub} ${t.sub}`),!1):this.equalityService.isStringEqualOrNonOrderedArrayEqual(a?.aud,t?.aud)?n?!0:a.auth_time!==t.auth_time?(this.loggerService.logDebug(r,`auth_time do not match: ${a.auth_time} ${t.auth_time}`),!1):!0:(this.loggerService.logDebug(r,`aud in new id_token is not valid: '${a?.aud}' '${t.aud}'`),!1)}handleSuccessfulValidation(e){let{autoCleanStateAfterAuthentication:t}=e;this.storagePersistenceService.write("authNonce",null,e),t&&this.storagePersistenceService.write("authStateControl","",e),this.loggerService.logDebug(e,"authCallback token(s) validated, continue")}handleUnsuccessfulValidation(e){let{autoCleanStateAfterAuthentication:t}=e;this.storagePersistenceService.write("authNonce",null,e),t&&this.storagePersistenceService.write("authStateControl","",e),this.loggerService.logDebug(e,"authCallback token(s) invalid")}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),qt=(()=>{class s{constructor(){this.loggerService=o(S),this.stateValidationService=o(zt),this.authStateService=o(W),this.resetAuthDataService=o($),this.document=o(P)}callbackStateValidation(e,t,r){return this.stateValidationService.getValidatedStateResult(e,t).pipe(w(i=>{if(e.validationResult=i,i.authResponseIsValid)return this.authStateService.setAuthorizationData(i.accessToken,e.authResult,t,r),e;{let n=`authorizedCallback, token(s) validation failed, resetting. Hash: ${this.document.location.hash}`;throw this.loggerService.logWarning(t,n),this.resetAuthDataService.resetAuthorizationData(t,r),this.publishUnauthorizedState(e.validationResult,e.isRenewProcess,t.configId),new Error(n)}}))}publishUnauthorizedState(e,t,r){this.authStateService.updateAndPublishAuthState({isAuthenticated:!1,validationResult:e.state,isRenewProcess:t,configId:r})}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Bt=(()=>{class s{constructor(){this.loggerService=o(S),this.authStateService=o(W),this.flowsDataService=o(T),this.userService=o(B),this.resetAuthDataService=o($)}callbackUser(e,t,r){let{isRenewProcess:i,validationResult:n,authResult:a,refreshToken:c}=e,{autoUserInfo:l,renewUserInfoAfterTokenRenew:h}=t;return l?this.userService.getAndPersistUserDataInStore(t,r,i,n?.idToken,n?.decodedIdToken).pipe(D(f=>{if(f)return c||this.flowsDataService.setSessionState(a?.session_state,t),this.publishAuthState(n,i,t.configId),d(e);{this.resetAuthDataService.resetAuthorizationData(t,r),this.publishUnauthenticatedState(n,i,t.configId);let k=`Called for userData but they were ${f}`;return this.loggerService.logWarning(t,k),v(()=>new Error(k))}}),A(f=>{let k=`Failed to retrieve user info with error:  ${f}`;return this.loggerService.logWarning(t,k),v(()=>new Error(k))})):((!i||h)&&n?.decodedIdToken&&this.userService.setUserDataToStore(n.decodedIdToken,t,r),!i&&!c&&this.flowsDataService.setSessionState(a?.session_state,t),this.publishAuthState(n,i,t.configId),d(e))}publishAuthState(e,t,r){e&&this.authStateService.updateAndPublishAuthState({isAuthenticated:!0,validationResult:e.state,isRenewProcess:t,configId:r})}publishUnauthenticatedState(e,t,r){e&&this.authStateService.updateAndPublishAuthState({isAuthenticated:!1,validationResult:e.state,isRenewProcess:t,configId:r})}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),de=(()=>{class s{constructor(){this.codeFlowCallbackHandlerService=o($t),this.implicitFlowCallbackHandlerService=o(jt),this.historyJwtKeysCallbackHandlerService=o(Vt),this.userHandlerService=o(Bt),this.stateValidationCallbackHandlerService=o(qt),this.refreshSessionCallbackHandlerService=o(Nt),this.refreshTokenCallbackHandlerService=o(Kt)}processCodeFlowCallback(e,t,r){return this.codeFlowCallbackHandlerService.codeFlowCallback(e,t).pipe(I(i=>this.codeFlowCallbackHandlerService.codeFlowCodeRequest(i,t)),I(i=>this.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(i,t,r)),I(i=>this.stateValidationCallbackHandlerService.callbackStateValidation(i,t,r)),I(i=>this.userHandlerService.callbackUser(i,t,r)))}processSilentRenewCodeFlowCallback(e,t,r){return this.codeFlowCallbackHandlerService.codeFlowCodeRequest(e,t).pipe(I(i=>this.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(i,t,r)),I(i=>this.stateValidationCallbackHandlerService.callbackStateValidation(i,t,r)),I(i=>this.userHandlerService.callbackUser(i,t,r)))}processImplicitFlowCallback(e,t,r){return this.implicitFlowCallbackHandlerService.implicitFlowCallback(e,t,r).pipe(I(i=>this.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(i,e,t)),I(i=>this.stateValidationCallbackHandlerService.callbackStateValidation(i,e,t)),I(i=>this.userHandlerService.callbackUser(i,e,t)))}processRefreshToken(e,t,r){return this.refreshSessionCallbackHandlerService.refreshSessionWithRefreshTokens(e).pipe(I(i=>this.refreshTokenCallbackHandlerService.refreshTokensRequestTokens(i,e,r)),I(i=>this.historyJwtKeysCallbackHandlerService.callbackHistoryAndResetJwtKeys(i,e,t)),I(i=>this.stateValidationCallbackHandlerService.callbackStateValidation(i,e,t)),I(i=>this.userHandlerService.callbackUser(i,e,t)))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),ee=(()=>{class s{constructor(){this.runTokenValidationRunning=null,this.zone=o(Se),this.document=o(P)}isTokenValidationRunning(){return!!this.runTokenValidationRunning}stopPeriodicTokenCheck(){this.runTokenValidationRunning&&(this.runTokenValidationRunning.unsubscribe(),this.runTokenValidationRunning=null)}startPeriodicTokenCheck(e){let t=e*1e3;return new Q(r=>{let i;return this.zone.runOutsideAngular(()=>{i=this.document?.defaultView?.setInterval(()=>this.zone.run(()=>r.next()),t)}),()=>{clearInterval(i)}})}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),_t=(()=>{class s{constructor(){this.flowsService=o(de),this.router=o(ae),this.flowsDataService=o(T),this.intervalService=o(ee)}authenticatedCallbackWithCode(e,t,r){let i=this.flowsDataService.isSilentRenewRunning(t),{triggerAuthorizationResultEvent:n}=t,a=t.postLoginRoute||"/",c=t.unauthorizedRoute||"/";return this.flowsService.processCodeFlowCallback(e,t,r).pipe(F(l=>{this.flowsDataService.resetCodeFlowInProgress(t),!n&&!l.isRenewProcess&&this.router.navigateByUrl(a)}),A(l=>(this.flowsDataService.resetSilentRenewRunning(t),this.flowsDataService.resetCodeFlowInProgress(t),this.intervalService.stopPeriodicTokenCheck(),!n&&!i&&this.router.navigateByUrl(c),v(()=>new Error(l)))))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),it=(()=>{class s{constructor(){this.flowsService=o(de),this.router=o(ae),this.flowsDataService=o(T),this.intervalService=o(ee)}authenticatedImplicitFlowCallback(e,t,r){let i=this.flowsDataService.isSilentRenewRunning(e),n=!!e.triggerAuthorizationResultEvent,a=e.postLoginRoute??"",c=e.unauthorizedRoute??"";return this.flowsService.processImplicitFlowCallback(e,t,r).pipe(F(l=>{!n&&!l.isRenewProcess&&this.router.navigateByUrl(a)}),A(l=>(this.flowsDataService.resetSilentRenewRunning(e),this.intervalService.stopPeriodicTokenCheck(),!n&&!i&&this.router.navigateByUrl(c),v(()=>new Error(l)))))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),nt=(()=>{class s{constructor(){this.urlService=o(M),this.flowHelper=o(O),this.implicitFlowCallbackService=o(it),this.codeFlowCallbackService=o(_t),this.stsCallbackInternal$=new te}get stsCallback$(){return this.stsCallbackInternal$.asObservable()}isCallback(e,t){return e?this.urlService.isCallbackFromSts(e,t):!1}handleCallbackAndFireEvents(e,t,r){let i=new Q;if(this.flowHelper.isCurrentFlowCodeFlow(t))i=this.codeFlowCallbackService.authenticatedCallbackWithCode(e,t,r);else if(this.flowHelper.isCurrentFlowAnyImplicitFlow(t))if(e?.includes("#")){let n=e.substring(e.indexOf("#")+1);i=this.implicitFlowCallbackService.authenticatedImplicitFlowCallback(t,r,n)}else i=this.implicitFlowCallbackService.authenticatedImplicitFlowCallback(t,r);return i.pipe(F(()=>this.stsCallbackInternal$.next()))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Jt=(()=>{class s{constructor(){this.platformId=o(Ve)}isBrowser(){return Ke(this.platformId)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Ye="/.well-known/openid-configuration",Gt=(()=>{class s{constructor(){this.loggerService=o(S),this.http=o(N)}getWellKnownEndPointsForConfig(e){let{authWellknownEndpointUrl:t,authWellknownEndpoints:r={}}=e;if(!t){let i="no authWellknownEndpoint given!";return this.loggerService.logError(e,i),v(()=>new Error(i))}return this.getWellKnownDocument(t,e).pipe(w(i=>({issuer:i.issuer,jwksUri:i.jwks_uri,authorizationEndpoint:i.authorization_endpoint,tokenEndpoint:i.token_endpoint,userInfoEndpoint:i.userinfo_endpoint,endSessionEndpoint:i.end_session_endpoint,checkSessionIframe:i.check_session_iframe,revocationEndpoint:i.revocation_endpoint,introspectionEndpoint:i.introspection_endpoint,parEndpoint:i.pushed_authorization_request_endpoint})),w(i=>y(y({},i),r)),F(i=>{let n=i.issuer||"",a=e.authWellknownUrlSuffix||Ye,c=t.replace(a,"");if(n!==c&&n!==`${c}/`){let l=`Issuer mismatch. Well known issuer ${i.issuer} does not match configured well known url ${t}`;throw this.loggerService.logError(e,l),new Error(l)}}))}getWellKnownDocument(e,t){let r=e,i=t.authWellknownUrlSuffix||Ye;return e.includes(i)||(r=`${e}${i}`),this.http.get(r,t).pipe(L(2))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),_=(()=>{class s{constructor(){this.dataService=o(Gt),this.publicEventsService=o(j),this.storagePersistenceService=o(b)}storeWellKnownEndpoints(e,t){this.storagePersistenceService.write("authWellKnownEndPoints",t,e)}queryAndStoreAuthWellKnownEndPoints(e){return e?this.dataService.getWellKnownEndPointsForConfig(e).pipe(F(t=>this.storeWellKnownEndpoints(e,t)),A(t=>(this.publicEventsService.fireEvent(C.ConfigLoadingFailed,null),v(()=>new Error(t))))):v(()=>new Error("Please provide a configuration before setting up the module"))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Qt={authority:"https://please_set",authWellknownEndpointUrl:"",authWellknownEndpoints:void 0,redirectUrl:"https://please_set",checkRedirectUrlWhenCheckingIfIsCallback:!0,clientId:"please_set",responseType:"code",scope:"openid email profile",hdParam:"",postLogoutRedirectUri:"https://please_set",startCheckSession:!1,silentRenew:!1,silentRenewUrl:"https://please_set",silentRenewTimeoutInSeconds:20,renewTimeBeforeTokenExpiresInSeconds:0,useRefreshToken:!1,usePushedAuthorisationRequests:!1,ignoreNonceAfterRefresh:!1,postLoginRoute:"/",forbiddenRoute:"/forbidden",unauthorizedRoute:"/unauthorized",autoUserInfo:!0,autoCleanStateAfterAuthentication:!0,triggerAuthorizationResultEvent:!1,logLevel:Z.Warn,issValidationOff:!1,historyCleanupOff:!1,maxIdTokenIatOffsetAllowedInSeconds:120,disableIatOffsetValidation:!1,customParamsAuthRequest:{},customParamsRefreshTokenRequest:{},customParamsEndSessionRequest:{},customParamsCodeRequest:{},disableRefreshIdTokenAuthTimeValidation:!1,triggerRefreshWhenIdTokenExpired:!0,tokenRefreshInSeconds:4,refreshTokenRetryInSeconds:3,ngswBypass:!1},J={result:!0,messages:[],level:"none"},Yt=s=>s.authority?J:{result:!1,messages:["The authority URL MUST be provided in the configuration! "],level:"error"},Xt=s=>s.clientId?J:{result:!1,messages:["The clientId is required and missing from your config!"],level:"error"},Zt=s=>{if(!s)return"";let{authority:u,clientId:e,scope:t}=s;return`${u}${e}${t}`},er=s=>new Set(s).size!==s.length,tr=s=>{let u=s.map(r=>Zt(r));return u.some(r=>r==="")?{result:!1,messages:["Please make sure you add an object with a 'config' property: ....({ config }) instead of ...(config)"],level:"error"}:er(u)?{result:!1,messages:["You added multiple configs with the same authority, clientId and scope"],level:"warning"}:J},rr=s=>s.redirectUrl?J:{result:!1,messages:["The redirectUrl is required and missing from your config"],level:"error"},sr=s=>{let u=s.silentRenew,e=s.useRefreshToken,t=s.silentRenewUrl;return u&&!e&&!t?{result:!1,messages:["Please provide a silent renew URL if using renew and not refresh tokens"],level:"error"}:J},ir=s=>{let u=s.useRefreshToken,e=s.silentRenew,r=(s.scope||"").split(" ").includes("offline_access");return u&&e&&!r?{result:!1,messages:["When using silent renew and refresh tokens please set the `offline_access` scope"],level:"warning"}:J},nr=[Yt,ir,rr,Xt,sr],or=[tr],ar=(()=>{class s{constructor(){this.loggerService=o(S)}validateConfigs(e){return this.validateConfigsInternal(e??[],or)}validateConfig(e){return this.validateConfigInternal(e,nr)}validateConfigsInternal(e,t){if(e.length===0)return!1;let r=t.map(n=>n(e)),i=0;return e.forEach(n=>{let a=this.processValidationResultsAndGetErrorCount(r,n);i+=a}),i===0}validateConfigInternal(e,t){let r=t.map(n=>n(e));return this.processValidationResultsAndGetErrorCount(r,e)===0}processValidationResultsAndGetErrorCount(e,t){let r=e.filter(a=>a.messages.length>0),i=this.getAllMessagesOfType("error",r),n=this.getAllMessagesOfType("warning",r);return i.forEach(a=>this.loggerService.logError(t,a)),n.forEach(a=>this.loggerService.logWarning(t,a)),i.length}getAllMessagesOfType(e,t){return t.filter(i=>i.level===e).map(i=>i.messages).reduce((i,n)=>i.concat(n),[])}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),ye=(()=>{class s{constructor(){this.configsInternal={},this.loggerService=o(S),this.publicEventsService=o(j),this.storagePersistenceService=o(b),this.platformProvider=o(Jt),this.authWellKnownService=o(_),this.loader=o(ce),this.configValidationService=o(ar)}hasManyConfigs(){return Object.keys(this.configsInternal).length>1}getAllConfigurations(){return Object.values(this.configsInternal)}getOpenIDConfiguration(e){return this.configsAlreadySaved()?d(this.getConfig(e)):this.getOpenIDConfigurations(e).pipe(w(t=>t.currentConfig))}getOpenIDConfigurations(e){return this.loadConfigs().pipe(I(t=>this.prepareAndSaveConfigs(t)),w(t=>({allConfigs:t,currentConfig:this.getConfig(e)})))}hasAtLeastOneConfig(){return Object.keys(this.configsInternal).length>0}saveConfig(e){let{configId:t}=e;this.configsInternal[t]=e}loadConfigs(){return this.loader.loadConfigs()}configsAlreadySaved(){return this.hasAtLeastOneConfig()}getConfig(e){if(e){let r=this.configsInternal[e];return!r&&Ne()&&console.warn(`[angular-auth-oidc-client] No configuration found for config id '${e}'.`),r||null}let[,t]=Object.entries(this.configsInternal)[0]||[[null,null]];return t||null}prepareAndSaveConfigs(e){if(!this.configValidationService.validateConfigs(e))return d([]);this.createUniqueIds(e);let t=e.map(r=>this.handleConfig(r));return K(t).pipe(w(r=>r.filter(i=>!!i)),w(r=>r))}createUniqueIds(e){e.forEach((t,r)=>{t.configId||(t.configId=`${r}-${t.clientId}`)})}handleConfig(e){if(!this.configValidationService.validateConfig(e))return this.loggerService.logError(e,"Validation of config rejected with errors. Config is NOT set."),d(null);e.authWellknownEndpointUrl||(e.authWellknownEndpointUrl=e.authority);let t=this.prepareConfig(e);this.saveConfig(t);let r=this.enhanceConfigWithWellKnownEndpoint(t);return this.publicEventsService.fireEvent(C.ConfigLoaded,r),d(t)}enhanceConfigWithWellKnownEndpoint(e){let t=this.storagePersistenceService.read("authWellKnownEndPoints",e);if(t)return e.authWellknownEndpoints=t,e;let r=e.authWellknownEndpoints;return r&&(this.authWellKnownService.storeWellKnownEndpoints(e,r),e.authWellknownEndpoints=r),e}prepareConfig(e){let t=y(y({},Qt),e);return this.setSpecialCases(t),t}setSpecialCases(e){this.platformProvider.isBrowser()||(e.startCheckSession=!1,e.silentRenew=!1,e.useRefreshToken=!1,e.usePushedAuthorisationRequests=!1)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),ot=(()=>{class s{constructor(){this.document=o(P),this.loggerService=o(S)}getExistingIFrame(e){let t=this.getIFrameFromParentWindow(e);if(this.isIFrameElement(t))return t;let r=this.getIFrameFromWindow(e);return this.isIFrameElement(r)?r:null}addIFrameToWindowBody(e,t){let r=this.document.createElement("iframe");return r.id=e,r.title=e,this.loggerService.logDebug(t,r),r.style.display="none",this.document.body.appendChild(r),r}getIFrameFromParentWindow(e){try{let t=this.document.defaultView?.parent.document.getElementById(e);return this.isIFrameElement(t)?t:null}catch{return null}}getIFrameFromWindow(e){let t=this.document.getElementById(e);return this.isIFrameElement(t)?t:null}isIFrameElement(e){return!!e&&e instanceof HTMLIFrameElement}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),cr="myiFrameForSilentRenew",at=s=>`${cr}_${s}`,Re=(()=>{class s{constructor(){this.refreshSessionWithIFrameCompletedInternal$=new te,this.loggerService=o(S),this.iFrameService=o(ot),this.flowsService=o(de),this.resetAuthDataService=o($),this.flowsDataService=o(T),this.authStateService=o(W),this.flowHelper=o(O),this.implicitFlowCallbackService=o(it),this.intervalService=o(ee)}get refreshSessionWithIFrameCompleted$(){return this.refreshSessionWithIFrameCompletedInternal$.asObservable()}getOrCreateIframe(e){let t=at(e.configId),r=this.iFrameService.getExistingIFrame(t);return r?(this.loggerService.logDebug(e,`Using existing iframe: ${t}`),r):(this.loggerService.logDebug(e,`Creating new iframe: ${t}`),this.iFrameService.addIFrameToWindowBody(t,e))}isSilentRenewConfigured(e){let{useRefreshToken:t,silentRenew:r}=e;return!t&&!!r}codeFlowCallbackSilentRenewIframe(e,t,r){let i=new oe({fromString:e[1]}),n=i.get("error");if(n)return this.authStateService.updateAndPublishAuthState({isAuthenticated:!1,validationResult:R.LoginRequired,isRenewProcess:!0,configId:t.configId}),this.resetAuthDataService.resetAuthorizationData(t,r),this.flowsDataService.setNonce("",t),this.intervalService.stopPeriodicTokenCheck(),v(()=>new Error(n));let a=i.get("code")??"",c=i.get("state")??"",l=i.get("session_state"),h={code:a,refreshToken:"",state:c,sessionState:l,authResult:null,isRenewProcess:!0,jwtKeys:null,validationResult:null,existingIdToken:null};return this.flowsService.processSilentRenewCodeFlowCallback(h,t,r).pipe(A(f=>(this.intervalService.stopPeriodicTokenCheck(),this.resetAuthDataService.resetAuthorizationData(t,r),v(()=>new Error(f)))))}silentRenewEventHandler(e,t,r){if(this.loggerService.logDebug(t,"silentRenewEventHandler"),!e.detail)return;let i;if(this.flowHelper.isCurrentFlowCodeFlow(t)){let a=e.detail.toString().split("?");i=this.codeFlowCallbackSilentRenewIframe(a,t,r)}else i=this.implicitFlowCallbackService.authenticatedImplicitFlowCallback(t,r,e.detail);i.subscribe({next:({authResult:a})=>{this.refreshSessionWithIFrameCompletedInternal$.next({authResult:a,configId:t.configId,success:!0}),this.flowsDataService.resetSilentRenewRunning(t)},error:a=>{this.loggerService.logError(t,"Error: "+a),this.refreshSessionWithIFrameCompletedInternal$.next({configId:t.configId,success:!1}),this.flowsDataService.resetSilentRenewRunning(t)}})}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),ct=(()=>{class s{constructor(){this.renderer=o(je).createRenderer(null,null),this.loggerService=o(S),this.urlService=o(M),this.silentRenewService=o(Re),this.document=o(P)}refreshSessionWithIframe(e,t,r){return this.loggerService.logDebug(e,"BEGIN refresh session Authorize Iframe renew"),this.urlService.getRefreshSessionSilentRenewUrl(e,r).pipe(D(i=>this.sendAuthorizeRequestUsingSilentRenew(i,e,t)))}sendAuthorizeRequestUsingSilentRenew(e,t,r){let i=this.silentRenewService.getOrCreateIframe(t);return this.initSilentRenewRequest(t,r),this.loggerService.logDebug(t,`sendAuthorizeRequestUsingSilentRenew for URL: ${e}`),new Q(n=>{let a=()=>{i.removeEventListener("load",a),this.loggerService.logDebug(t,"removed event listener from IFrame"),n.next(!0),n.complete()};i.addEventListener("load",a),i.contentWindow?.location.replace(e??"")})}initSilentRenewRequest(e,t){let r=Math.random();this.loggerService.logDebug(e,`Creating new silent renew handlers for config: ${e.configId}, instance: ${r}`);let i=this.renderer.listen("window","oidc-silent-renew-init",a=>{let c=a.detail;c.configId===e.configId&&c.instanceId!==r&&(this.loggerService.logDebug(e,`Destroying old handlers for config: ${e.configId} (old instance: ${r}, new instance: ${c.instanceId})`),i(),n())}),n=this.renderer.listen("window","oidc-silent-renew-message",a=>{if(this.shouldProcessRenewMessage(a,e)){let c=this.convertToLegacyEvent(a);this.silentRenewService.silentRenewEventHandler(c,e,t)}});this.document.defaultView?.dispatchEvent(new CustomEvent("oidc-silent-renew-init",{detail:{instanceId:r,configId:e.configId}}))}shouldProcessRenewMessage(e,t){if(!e?.detail)return this.loggerService.logDebug(t,`Silent renew event has no valid payload: ${e?.detail}`),!1;if(e.detail.srcFrameId){let r=at(t.configId)===e.detail.srcFrameId;return this.loggerService.logDebug(t,`Silent renew event from frame: ${e.detail.srcFrameId}, current configId: ${t.configId}, processing: ${r}`),r}return this.loggerService.logDebug(t,"Silent renew event without srcFrameId - processing for backward compatibility"),!0}convertToLegacyEvent(e){return e?.detail?.url?new CustomEvent(e.type,{detail:e.detail.url}):e}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),lt=(()=>{class s{constructor(){this.loggerService=o(S),this.resetAuthDataService=o($),this.flowsService=o(de),this.intervalService=o(ee)}refreshSessionWithRefreshTokens(e,t,r){this.loggerService.logDebug(e,"BEGIN refresh session Authorize");let i=!1;return this.flowsService.processRefreshToken(e,t,r).pipe(A(n=>(this.resetAuthDataService.resetAuthorizationData(e,t),i=!0,v(()=>new Error(n)))),Oe(()=>i&&this.intervalService.stopPeriodicTokenCheck()))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),lr=(()=>{class s{constructor(){this.resetAuthDataService=o($),this.flowHelper=o(O),this.flowsDataService=o(T),this.loggerService=o(S),this.userService=o(B),this.authStateService=o(W),this.refreshSessionIframeService=o(ct),this.refreshSessionRefreshTokenService=o(lt),this.intervalService=o(ee),this.storagePersistenceService=o(b),this.publicEventsService=o(j),this.configurationService=o(ye)}startTokenValidationPeriodically(e,t){let r=this.getConfigsWithSilentRenewEnabled(e);if(r.length<=0||this.intervalService.isTokenValidationRunning())return;let i=this.getSmallestRefreshTimeFromConfigs(r),n=this.intervalService.startPeriodicTokenCheck(i).pipe(D(()=>{let a={};return r.forEach(c=>{let l=c.configId;a[l]=this.getRefreshEvent(c,e)}),K(a)}));this.intervalService.runTokenValidationRunning=n.pipe(A(a=>v(()=>new Error(a)))).subscribe({next:a=>{for(let[c,l]of Object.entries(a))this.configurationService.getOpenIDConfiguration(c).subscribe(h=>{this.loggerService.logDebug(h,"silent renew, periodic check finished!"),this.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens(h)&&this.flowsDataService.resetSilentRenewRunning(h)})},error:a=>{this.loggerService.logError(t,"silent renew failed!",a)}})}getRefreshEvent(e,t){if(!this.shouldStartPeriodicallyCheckForConfig(e))return d(null);let i=this.createRefreshEventForConfig(e,t);return this.publicEventsService.fireEvent(C.SilentRenewStarted),i.pipe(A(n=>(this.loggerService.logError(e,"silent renew failed!",n),this.publicEventsService.fireEvent(C.SilentRenewFailed,n),this.flowsDataService.resetSilentRenewRunning(e),v(()=>new Error(n)))))}getSmallestRefreshTimeFromConfigs(e){return e.reduce((r,i)=>(r.tokenRefreshInSeconds??0)<(i.tokenRefreshInSeconds??0)?r:i).tokenRefreshInSeconds??0}getConfigsWithSilentRenewEnabled(e){return e.filter(t=>t.silentRenew)}createRefreshEventForConfig(e,t){return this.loggerService.logDebug(e,"starting silent renew..."),this.configurationService.getOpenIDConfiguration(e.configId).pipe(D(r=>{if(!r?.silentRenew)return this.resetAuthDataService.resetAuthorizationData(r,t),d(null);if(this.flowsDataService.setSilentRenewRunning(r),this.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens(r)){let n=this.storagePersistenceService.read("storageCustomParamsRefresh",r)||{},{customParamsRefreshTokenRequest:a}=r,c=y(y({},a),n);return this.refreshSessionRefreshTokenService.refreshSessionWithRefreshTokens(r,t,c)}let i=this.storagePersistenceService.read("storageCustomParamsAuthRequest",r);return this.refreshSessionIframeService.refreshSessionWithIframe(r,t,i)}))}shouldStartPeriodicallyCheckForConfig(e){let t=this.authStateService.getIdToken(e),r=this.flowsDataService.isSilentRenewRunning(e),i=this.flowsDataService.isCodeFlowInProgress(e),n=this.userService.getUserDataFromStore(e);if(this.loggerService.logDebug(e,`Checking: silentRenewRunning: ${r}, isCodeFlowInProgress: ${i} - has idToken: ${!!t} - has userData: ${!!n}`),!(!!n&&!r&&!!t&&!i))return!1;let c=this.authStateService.hasIdTokenExpiredAndRenewCheckIsEnabled(e),l=this.authStateService.hasAccessTokenExpiredIfExpiryExists(e);return c||l}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),hr=3,ht=(()=>{class s{constructor(){this.flowHelper=o(O),this.flowsDataService=o(T),this.loggerService=o(S),this.silentRenewService=o(Re),this.authStateService=o(W),this.authWellKnownService=o(_),this.refreshSessionIframeService=o(ct),this.storagePersistenceService=o(b),this.refreshSessionRefreshTokenService=o(lt),this.userService=o(B)}userForceRefreshSession(e,t,r){return e?(this.persistCustomParams(r,e),this.forceRefreshSession(e,t,r).pipe(F(()=>this.flowsDataService.resetSilentRenewRunning(e)))):v(()=>new Error("Please provide a configuration before setting up the module"))}forceRefreshSession(e,t,r){let{customParamsRefreshTokenRequest:i,configId:n}=e,a=y(y({},i),r);if(this.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens(e))return this.startRefreshSession(e,t,a).pipe(w(()=>{let h=this.authStateService.areAuthStorageTokensValid(e);return h?{idToken:this.authStateService.getIdToken(e),accessToken:this.authStateService.getAccessToken(e),userData:this.userService.getUserDataFromStore(e),isAuthenticated:h,configId:n}:{isAuthenticated:!1,errorMessage:"",userData:null,idToken:"",accessToken:"",configId:n}}));let{silentRenewTimeoutInSeconds:c}=e,l=(c??0)*1e3;return K([this.startRefreshSession(e,t,r),this.silentRenewService.refreshSessionWithIFrameCompleted$.pipe(We(h=>h?.configId===e.configId),Y(1))]).pipe(Ue(l),ne(h=>h.pipe(V((f,k)=>{let p=k+1;return!(f instanceof Fe)||p>hr?v(()=>new Error(f)):(this.loggerService.logDebug(e,`forceRefreshSession timeout. Attempt #${p}`),this.flowsDataService.resetSilentRenewRunning(e),ie(p*1e3))}))),w(([h,f])=>{let k=this.authStateService.areAuthStorageTokensValid(e);if(k){let E=f.success?f.authResult:null;return{idToken:E?.id_token??"",accessToken:E?.access_token??"",userData:this.userService.getUserDataFromStore(e),isAuthenticated:k,configId:n}}return{isAuthenticated:!1,errorMessage:"",userData:null,idToken:"",accessToken:"",configId:n}}))}persistCustomParams(e,t){let{useRefreshToken:r}=t;e&&(r?this.storagePersistenceService.write("storageCustomParamsRefresh",e,t):this.storagePersistenceService.write("storageCustomParamsAuthRequest",e,t))}startRefreshSession(e,t,r){let i=this.flowsDataService.isSilentRenewRunning(e);return this.loggerService.logDebug(e,`Checking: silentRenewRunning: ${i}`),!i?this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(e).pipe(D(()=>(this.flowsDataService.setSilentRenewRunning(e),this.flowHelper.isCurrentFlowCodeFlowWithRefreshTokens(e)?this.refreshSessionRefreshTokenService.refreshSessionWithRefreshTokens(e,t,r):this.refreshSessionIframeService.refreshSessionWithIframe(e,t,r)))):d(null)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Xe="myiFrameForCheckSession",De=(()=>{class s{constructor(){this.checkSessionReceived=!1,this.scheduledHeartBeatRunning=null,this.lastIFrameRefresh=0,this.outstandingMessages=0,this.loggerService=o(S),this.storagePersistenceService=o(b),this.iFrameService=o(ot),this.eventService=o(j),this.zone=o(Se),this.document=o(P),this.heartBeatInterval=3e3,this.iframeRefreshInterval=6e4,this.checkSessionChangedInternal$=new re(!1)}get checkSessionChanged$(){return this.checkSessionChangedInternal$.asObservable()}ngOnDestroy(){this.stop();let e=this.document.defaultView;e&&this.iframeMessageEventListener&&e.removeEventListener("message",this.iframeMessageEventListener,!1)}isCheckSessionConfigured(e){let{startCheckSession:t}=e;return!!t}start(e){if(this.scheduledHeartBeatRunning)return;let{clientId:t}=e;this.pollServerSession(t,e)}stop(){this.scheduledHeartBeatRunning&&(this.clearScheduledHeartBeat(),this.checkSessionReceived=!1)}serverStateChanged(e){let{startCheckSession:t}=e;return!!t&&this.checkSessionReceived}getExistingIframe(){return this.iFrameService.getExistingIFrame(Xe)}init(e){if(this.lastIFrameRefresh+this.iframeRefreshInterval>Date.now())return d();let t=this.storagePersistenceService.read("authWellKnownEndPoints",e);if(!t)return this.loggerService.logWarning(e,"CheckSession - init check session: authWellKnownEndpoints is undefined. Returning."),d();let r=this.getOrCreateIframe(e);this.bindMessageEventToIframe(e);let i=t.checkSessionIframe,n=r.contentWindow;return i?(n?n.location.replace(i):this.loggerService.logWarning(e,"CheckSession - init check session: IFrame contentWindow does not exist"),new Q(a=>{r.onload=()=>{this.lastIFrameRefresh=Date.now(),a.next(),a.complete()}})):(this.loggerService.logWarning(e,"CheckSession - init check session: checkSessionIframe is not configured to run"),d())}pollServerSession(e,t){this.outstandingMessages=0;let r=()=>{this.init(t).pipe(Y(1)).subscribe(()=>{let i=this.getExistingIframe();if(i&&e){this.loggerService.logDebug(t,`CheckSession - clientId : '${e}' - existingIframe: '${i}'`);let n=this.storagePersistenceService.read("session_state",t),a=this.storagePersistenceService.read("authWellKnownEndPoints",t),c=i.contentWindow;if(n&&a?.checkSessionIframe&&c){let l=new URL(a.checkSessionIframe)?.origin;this.outstandingMessages++,c.postMessage(e+" "+n,l)}else this.loggerService.logDebug(t,`CheckSession - session_state is '${n}' - AuthWellKnownEndPoints is '${JSON.stringify(a,null,2)}'`),this.checkSessionChangedInternal$.next(!0)}else this.loggerService.logWarning(t,`CheckSession - OidcSecurityCheckSession pollServerSession checkSession IFrame does not exist:
               clientId : '${e}' - existingIframe: '${i}'`);this.outstandingMessages>3&&this.loggerService.logError(t,`CheckSession - OidcSecurityCheckSession not receiving check session response messages.
                            Outstanding messages: '${this.outstandingMessages}'. Server unreachable?`),this.zone.runOutsideAngular(()=>{this.scheduledHeartBeatRunning=this.document?.defaultView?.setTimeout(()=>this.zone.run(r),this.heartBeatInterval)??null})})};r()}clearScheduledHeartBeat(){this.scheduledHeartBeatRunning!==null&&(clearTimeout(this.scheduledHeartBeatRunning),this.scheduledHeartBeatRunning=null)}messageHandler(e,t){let r=this.getExistingIframe(),n=!!this.storagePersistenceService.read("authWellKnownEndPoints",e)?.checkSessionIframe?.startsWith(t.origin);this.outstandingMessages=0,r&&n&&t.source===r.contentWindow&&(t.data==="error"?this.loggerService.logWarning(e,"CheckSession - error from check session messageHandler"):t.data==="changed"?(this.loggerService.logDebug(e,`CheckSession - ${t} from check session messageHandler`),this.checkSessionReceived=!0,this.eventService.fireEvent(C.CheckSessionReceived,t.data),this.checkSessionChangedInternal$.next(!0)):(this.eventService.fireEvent(C.CheckSessionReceived,t.data),this.loggerService.logDebug(e,`CheckSession - ${t.data} from check session messageHandler`)))}bindMessageEventToIframe(e){let t=this.document.defaultView;this.iframeMessageEventListener&&t&&t.removeEventListener("message",this.iframeMessageEventListener,!1),this.iframeMessageEventListener=this.messageHandler.bind(this,e),t&&t.addEventListener("message",this.iframeMessageEventListener,!1)}getOrCreateIframe(e){return this.getExistingIframe()||this.iFrameService.addIFrameToWindowBody(Xe,e)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),ge=(()=>{class s{constructor(){this.popUp=null,this.handle=-1,this.loggerService=o(S),this.storagePersistenceService=o(b),this.document=o(P),this.STORAGE_IDENTIFIER="popupauth",this.resultInternal$=new te}get result$(){return this.resultInternal$.asObservable()}get windowInternal(){return this.document.defaultView}isCurrentlyInPopup(e){if(this.canAccessSessionStorage()){let t=this.storagePersistenceService.read(this.STORAGE_IDENTIFIER,e),r=this.windowInternal;return r?!!r.opener&&r.opener!==r&&!!t:!1}return!1}openPopUp(e,t,r){let i=this.getOptions(t);this.storagePersistenceService.write(this.STORAGE_IDENTIFIER,"true",r);let n=this.windowInternal;if(!n)return;if(!e){this.loggerService.logError(r,"Could not open popup, url is empty");return}if(this.popUp=n.open(e,"_blank",i),!this.popUp){this.storagePersistenceService.remove(this.STORAGE_IDENTIFIER,r),this.loggerService.logError(r,"Could not open popup");return}this.loggerService.logDebug(r,"Opened popup with url "+e);let a=c=>{if(!c?.data||typeof c.data!="string"){if(r.disableCleaningPopupOnInvalidMessage)return;this.cleanUp(a,r);return}this.loggerService.logDebug(r,"Received message from popup with url "+c.data),this.resultInternal$.next({userClosed:!1,receivedUrl:c.data}),this.cleanUp(a,r)};n.addEventListener("message",a,!1),this.handle=n.setInterval(()=>{this.popUp?.closed&&(this.resultInternal$.next({userClosed:!0,receivedUrl:""}),this.cleanUp(a,r))},200)}sendMessageToMainWindow(e,t){let r=this.windowInternal;if(r&&r.opener){let i=r.location.href;this.sendMessage(e,i,t)}}cleanUp(e,t){let r=this.windowInternal;r&&(r.removeEventListener("message",e,!1),r.clearInterval(this.handle),this.popUp&&(this.storagePersistenceService.remove(this.STORAGE_IDENTIFIER,t),this.popUp.close(),this.popUp=null))}sendMessage(e,t,r){let i=this.windowInternal;if(i){if(!e){this.loggerService.logDebug(r,`Can not send message to parent, no url: '${e}'`);return}i.opener.postMessage(e,t)}}getOptions(e){let t={width:500,height:500,left:50,top:50},r=y(y({},t),e||{}),i=this.windowInternal;if(!i)return"";let n=r.width||t.width,a=r.height||t.height,c=i.screenLeft+(i.outerWidth-n)/2,l=i.screenTop+(i.outerHeight-a)/2;return r.left=c,r.top=l,Object.entries(r).map(([h,f])=>`${encodeURIComponent(h)}=${encodeURIComponent(f)}`).join(",")}canAccessSessionStorage(){return typeof navigator<"u"&&navigator.cookieEnabled&&typeof Storage<"u"}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),ur=(()=>{class s{constructor(){this.document=o(P)}getStateParamFromCurrentUrl(e){let t=e||this.getCurrentUrl();if(!t)return null;let r=new URL(t);return new URLSearchParams(r.search).get("state")}getCurrentUrl(){return this.document?.defaultView?.location.toString()??null}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Ee=(()=>{class s{constructor(){this.checkSessionService=o(De),this.currentUrlService=o(ur),this.silentRenewService=o(Re),this.userService=o(B),this.loggerService=o(S),this.authStateService=o(W),this.callbackService=o(nt),this.refreshSessionService=o(ht),this.periodicallyTokenCheckService=o(lr),this.popupService=o(ge),this.autoLoginService=o(Pt),this.storagePersistenceService=o(b),this.publicEventsService=o(j)}checkAuth(e,t,r){if(!e)return v(()=>new Error("Please provide a configuration before setting up the module"));this.publicEventsService.fireEvent(C.CheckingAuth);let i=this.currentUrlService.getStateParamFromCurrentUrl(r);return this.getConfig(e,r)?this.checkAuthWithConfig(e,t,r):v(()=>new Error(`could not find matching config for state ${i}`))}checkAuthMultiple(e,t){let r=this.currentUrlService.getStateParamFromCurrentUrl(t);if(r){let a=this.getConfigurationWithUrlState(e,r);return a?this.composeMultipleLoginResults(e,a,t):v(()=>new Error(`could not find matching config for state ${r}`))}let i=e,n=i.map(a=>this.checkAuthWithConfig(a,i,t));return K(n)}checkAuthIncludingServer(e,t){return e?this.checkAuthWithConfig(e,t).pipe(D(r=>{let{isAuthenticated:i}=r;return i?d(r):this.refreshSessionService.forceRefreshSession(e,t).pipe(F(n=>{n?.isAuthenticated&&this.startCheckSessionAndValidation(e,t)}))})):v(()=>new Error("Please provide a configuration before setting up the module"))}getConfig(e,t){let r=this.currentUrlService.getStateParamFromCurrentUrl(t);return r?this.getConfigurationWithUrlState([e],r):e}checkAuthWithConfig(e,t,r){if(!e){let h="Please provide at least one configuration before setting up the module";return this.loggerService.logError(e,h),d({isAuthenticated:!1,errorMessage:h,userData:null,idToken:"",accessToken:"",configId:""})}let i=r||this.currentUrlService.getCurrentUrl();if(!i){let h="No URL found!";return this.loggerService.logError(e,h),d({isAuthenticated:!1,errorMessage:h,userData:null,idToken:"",accessToken:"",configId:""})}let{configId:n,authority:a}=e;if(this.loggerService.logDebug(e,`Working with config '${n}' using '${a}'`),this.popupService.isCurrentlyInPopup(e))return this.popupService.sendMessageToMainWindow(i,e),d({isAuthenticated:!1,errorMessage:"",userData:null,idToken:"",accessToken:"",configId:""});let c=this.callbackService.isCallback(i,e);return this.loggerService.logDebug(e,`currentUrl to check auth with: '${i}'`),(c?this.callbackService.handleCallbackAndFireEvents(i,e,t):d({})).pipe(w(()=>{let h=this.authStateService.areAuthStorageTokensValid(e);return this.loggerService.logDebug(e,`checkAuth completed. Firing events now. isAuthenticated: ${h}`),h&&(this.startCheckSessionAndValidation(e,t),c||(this.authStateService.setAuthenticatedAndFireEvent(t),this.userService.publishUserDataIfExists(e,t))),this.publicEventsService.fireEvent(C.CheckingAuthFinished),{isAuthenticated:h,userData:this.userService.getUserDataFromStore(e),accessToken:this.authStateService.getAccessToken(e),idToken:this.authStateService.getIdToken(e),configId:n}}),F(({isAuthenticated:h})=>{h&&this.autoLoginService.checkSavedRedirectRouteAndNavigate(e)}),A(({message:h})=>(this.loggerService.logError(e,h),this.publicEventsService.fireEvent(C.CheckingAuthFinishedWithError,h),d({isAuthenticated:!1,errorMessage:h,userData:null,idToken:"",accessToken:"",configId:n}))))}startCheckSessionAndValidation(e,t){this.checkSessionService.isCheckSessionConfigured(e)&&this.checkSessionService.start(e),this.periodicallyTokenCheckService.startTokenValidationPeriodically(t,e),this.silentRenewService.isSilentRenewConfigured(e)&&this.silentRenewService.getOrCreateIframe(e)}getConfigurationWithUrlState(e,t){if(!t)return null;for(let r of e)if(this.storagePersistenceService.read("authStateControl",r)===t)return r;return null}composeMultipleLoginResults(e,t,r){let i=e.filter(c=>c.configId!==t.configId),n=this.checkAuthWithConfig(t,e,r),a=i.map(c=>{let{redirectUrl:l}=c;return this.checkAuthWithConfig(c,e,l)});return K([n,...a])}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),be=(()=>{class s{constructor(){this.document=o(P)}redirectTo(e){this.document.location.href=e}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Ae=(()=>{class s{constructor(){this.loggerService=o(S),this.flowHelper=o(O)}hasConfigValidResponseType(e){return this.flowHelper.isCurrentFlowAnyImplicitFlow(e)||this.flowHelper.isCurrentFlowCodeFlow(e)?!0:(this.loggerService.logWarning(e,"module configured incorrectly, invalid response_type. Check the responseType in the config"),!1)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),dr=(()=>{class s{constructor(){this.loggerService=o(S),this.urlService=o(M),this.dataService=o(N),this.storagePersistenceService=o(b)}postParRequest(e,t){let r=new q;r=r.set("Content-Type","application/x-www-form-urlencoded");let i=this.storagePersistenceService.read("authWellKnownEndPoints",e);if(!i)return v(()=>new Error("Could not read PAR endpoint because authWellKnownEndPoints are not given"));let n=i.parEndpoint;return n?this.urlService.createBodyForParCodeFlowRequest(e,t).pipe(D(a=>this.dataService.post(n,a,e,r).pipe(L(2),w(c=>(this.loggerService.logDebug(e,"par response: ",c),{expiresIn:c.expires_in,requestUri:c.request_uri})),A(c=>{let l="There was an error on ParService postParRequest";return this.loggerService.logError(e,l,c),v(()=>new Error(l))})))):v(()=>new Error("Could not read PAR endpoint from authWellKnownEndpoints"))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),gr=(()=>{class s{constructor(){this.loggerService=o(S),this.responseTypeValidationService=o(Ae),this.urlService=o(M),this.redirectService=o(be),this.authWellKnownService=o(_),this.popupService=o(ge),this.checkAuthService=o(Ee),this.parService=o(dr)}loginPar(e,t){if(!this.responseTypeValidationService.hasConfigValidResponseType(e)){this.loggerService.logError(e,"Invalid response type!");return}this.loggerService.logDebug(e,"BEGIN Authorize OIDC Flow, no auth data"),this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(e).pipe(D(()=>this.parService.postParRequest(e,t))).subscribe(r=>{this.loggerService.logDebug(e,"par response: ",r);let i=this.urlService.getAuthorizeParUrl(r.requestUri,e);if(this.loggerService.logDebug(e,"par request url: ",i),!i){this.loggerService.logError(e,`Could not create URL with param ${r.requestUri}: '${i}'`);return}t?.urlHandler?t.urlHandler(i):this.redirectService.redirectTo(i)})}loginWithPopUpPar(e,t,r,i){let{configId:n}=e;if(!this.responseTypeValidationService.hasConfigValidResponseType(e)){let a="Invalid response type!";return this.loggerService.logError(e,a),v(()=>new Error(a))}return this.loggerService.logDebug(e,"BEGIN Authorize OIDC Flow with popup, no auth data"),this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(e).pipe(D(()=>this.parService.postParRequest(e,r)),D(a=>{this.loggerService.logDebug(e,`par response: ${a}`);let c=this.urlService.getAuthorizeParUrl(a.requestUri,e);if(this.loggerService.logDebug(e,"par request url: ",c),!c){let l=`Could not create URL with param ${a.requestUri}: 'url'`;return this.loggerService.logError(e,l),v(()=>new Error(l))}return this.popupService.openPopUp(c,i,e),this.popupService.result$.pipe(Y(1),D(l=>{let{userClosed:h,receivedUrl:f}=l;return h?d({isAuthenticated:!1,errorMessage:"User closed popup",userData:null,idToken:"",accessToken:"",configId:n}):this.checkAuthService.checkAuth(e,t,f)}))}))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),vr=(()=>{class s{constructor(){this.loggerService=o(S),this.responseTypeValidationService=o(Ae),this.urlService=o(M),this.authWellKnownService=o(_),this.popupService=o(ge),this.checkAuthService=o(Ee)}loginWithPopUpStandard(e,t,r,i){let{configId:n}=e;if(!this.responseTypeValidationService.hasConfigValidResponseType(e)){let a="Invalid response type!";return this.loggerService.logError(e,a),v(()=>new Error(a))}return this.loggerService.logDebug(e,"BEGIN Authorize OIDC Flow with popup, no auth data"),this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(e).pipe(D(()=>this.urlService.getAuthorizeUrl(e,r)),F(a=>this.popupService.openPopUp(a,i,e)),D(()=>this.popupService.result$.pipe(Y(1),D(a=>{let{userClosed:c,receivedUrl:l}=a;return c?d({isAuthenticated:!1,errorMessage:"User closed popup",userData:null,idToken:"",accessToken:"",configId:n}):this.checkAuthService.checkAuth(e,t,l)}))))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),fr=(()=>{class s{constructor(){this.loggerService=o(S),this.responseTypeValidationService=o(Ae),this.urlService=o(M),this.redirectService=o(be),this.authWellKnownService=o(_),this.flowsDataService=o(T)}loginStandard(e,t){if(!this.responseTypeValidationService.hasConfigValidResponseType(e)){this.loggerService.logError(e,"Invalid response type!");return}this.loggerService.logDebug(e,"BEGIN Authorize OIDC Flow, no auth data"),this.flowsDataService.setCodeFlowInProgress(e),this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(e).subscribe(()=>{let{urlHandler:r}=t||{};this.flowsDataService.resetSilentRenewRunning(e),this.urlService.getAuthorizeUrl(e,t).subscribe(i=>{if(!i){this.loggerService.logError(e,"Could not create URL",i);return}r?r(i):this.redirectService.redirectTo(i)})})}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),Sr=(()=>{class s{constructor(){this.parLoginService=o(gr),this.popUpLoginService=o(vr),this.standardLoginService=o(fr),this.storagePersistenceService=o(b),this.popupService=o(ge)}login(e,t){if(!e)throw new Error("Please provide a configuration before setting up the module");let{usePushedAuthorisationRequests:r}=e;return t?.customParams&&this.storagePersistenceService.write("storageCustomParamsAuthRequest",t.customParams,e),r?this.parLoginService.loginPar(e,t):this.standardLoginService.loginStandard(e,t)}loginWithPopUp(e,t,r,i){if(!e)throw new Error("Please provide a configuration before setting up the module");if(this.popupService.isCurrentlyInPopup(e))return d({errorMessage:"There is already a popup open."});let{usePushedAuthorisationRequests:a}=e;return r?.customParams&&this.storagePersistenceService.write("storageCustomParamsAuthRequest",r.customParams,e),a?this.parLoginService.loginWithPopUpPar(e,t,r,i):this.popUpLoginService.loginWithPopUpStandard(e,t,r,i)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();function pr(s){let u=y({},s);for(let e in s)(s[e]===void 0||s[e]===null)&&delete u[e];return u}var wr=(()=>{class s{constructor(){this.loggerService=o(S),this.dataService=o(N),this.storagePersistenceService=o(b),this.urlService=o(M),this.checkSessionService=o(De),this.resetAuthDataService=o($),this.redirectService=o(be)}logoff(e,t,r){if(!e)return v(()=>new Error("Please provide a configuration before setting up the module"));this.loggerService.logDebug(e,"logoff, remove auth",r);let{urlHandler:i,customParams:n}=r||{},a=this.urlService.getEndSessionUrl(e,n);return a?this.checkSessionService.serverStateChanged(e)?(this.loggerService.logDebug(e,"Server State changed. Logoff was only locally. Returning."),d(null)):i?(this.loggerService.logDebug(e,`Custom UrlHandler found. Using this to handle logoff with url '${a}'`),i(a),this.resetAuthDataService.resetAuthorizationData(e,t),d(null)):this.logoffInternal(r,a,e,t):(this.loggerService.logDebug(e,"No endsessionUrl present. Logoff was only locally. Returning."),d(null))}logoffLocal(e,t){this.resetAuthDataService.resetAuthorizationData(e,t),this.checkSessionService.stop()}logoffLocalMultiple(e){e.forEach(t=>this.logoffLocal(t,e))}logoffAndRevokeTokens(e,t,r){if(!e)return v(()=>new Error("Please provide a configuration before setting up the module"));let{revocationEndpoint:i}=this.storagePersistenceService.read("authWellKnownEndPoints",e)||{};return i?this.storagePersistenceService.getRefreshToken(e)?this.revokeRefreshToken(e).pipe(D(n=>this.revokeAccessToken(e)),A(n=>{let a="revoke token failed";return this.loggerService.logError(e,a,n),v(()=>new Error(a))}),I(()=>this.logoff(e,t,r))):this.revokeAccessToken(e).pipe(A(n=>{let a="revoke accessToken failed";return this.loggerService.logError(e,a,n),v(()=>new Error(a))}),I(()=>this.logoff(e,t,r))):(this.loggerService.logDebug(e,"revocation endpoint not supported"),this.logoff(e,t,r))}revokeAccessToken(e,t){if(!e)return v(()=>new Error("Please provide a configuration before setting up the module"));let r=t||this.storagePersistenceService.getAccessToken(e),i=this.urlService.createRevocationEndpointBodyAccessToken(r,e);return this.sendRevokeRequest(e,i)}revokeRefreshToken(e,t){if(!e)return v(()=>new Error("Please provide a configuration before setting up the module"));let r=t||this.storagePersistenceService.getRefreshToken(e),i=this.urlService.createRevocationEndpointBodyRefreshToken(r,e);return this.sendRevokeRequest(e,i)}logoffInternal(e,t,r,i){let{logoffMethod:n,customParams:a}=e||{};if(!n||n==="GET")return this.redirectService.redirectTo(t),this.resetAuthDataService.resetAuthorizationData(r,i),d(null);let{state:c,logout_hint:l,ui_locales:h}=a||{},{clientId:f}=r,k=this.storagePersistenceService.getIdToken(r),E=this.urlService.getPostLogoutRedirectUrl(r),p=this.getHeaders(),{url:H}=this.urlService.getEndSessionEndpoint(r),x=pr({id_token_hint:k,client_id:f,post_logout_redirect_uri:E,state:c,logout_hint:l,ui_locales:h});return this.resetAuthDataService.resetAuthorizationData(r,i),this.dataService.post(H,x,r,p)}sendRevokeRequest(e,t){let r=this.urlService.getRevocationEndpointUrl(e),i=this.getHeaders();return this.dataService.post(r,t,e,i).pipe(L(2),D(n=>(this.loggerService.logDebug(e,"revocation endpoint post response: ",n),d(n))),A(n=>{let a="Revocation request failed";return this.loggerService.logError(e,a,n),v(()=>new Error(a))}))}getHeaders(){let e=new q;return e=e.set("Content-Type","application/x-www-form-urlencoded"),e}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),ut=(()=>{class s{constructor(){this.checkSessionService=o(De),this.checkAuthService=o(Ee),this.userService=o(B),this.tokenHelperService=o(he),this.configurationService=o(ye),this.authStateService=o(W),this.flowsDataService=o(T),this.callbackService=o(nt),this.logoffRevocationService=o(wr),this.loginService=o(Sr),this.refreshSessionService=o(ht),this.urlService=o(M),this.authWellKnownService=o(_),this.userData=X(this.userData$,{requireSync:!0}),this.authenticated=X(this.isAuthenticated$,{requireSync:!0})}get userData$(){return this.userService.userData$}get isAuthenticated$(){return this.authStateService.authenticated$}get checkSessionChanged$(){return this.checkSessionService.checkSessionChanged$}get stsCallback$(){return this.callbackService.stsCallback$}preloadAuthWellKnownDocument(e){return this.configurationService.getOpenIDConfiguration(e).pipe(I(t=>this.authWellKnownService.queryAndStoreAuthWellKnownEndPoints(t)))}getConfigurations(){return this.configurationService.getAllConfigurations()}getConfiguration(e){return this.configurationService.getOpenIDConfiguration(e)}getUserData(e){return this.configurationService.getOpenIDConfiguration(e).pipe(w(t=>this.userService.getUserDataFromStore(t)))}checkAuth(e,t){return this.configurationService.getOpenIDConfigurations(t).pipe(I(({allConfigs:r,currentConfig:i})=>this.checkAuthService.checkAuth(i,r,e)))}checkAuthMultiple(e){return this.configurationService.getOpenIDConfigurations().pipe(I(({allConfigs:t})=>this.checkAuthService.checkAuthMultiple(t,e)))}isAuthenticated(e){return this.configurationService.getOpenIDConfiguration(e).pipe(w(t=>this.authStateService.isAuthenticated(t)))}checkAuthIncludingServer(e){return this.configurationService.getOpenIDConfigurations(e).pipe(I(({allConfigs:t,currentConfig:r})=>this.checkAuthService.checkAuthIncludingServer(r,t)))}getAccessToken(e){return this.configurationService.getOpenIDConfiguration(e).pipe(w(t=>this.authStateService.getAccessToken(t)))}getIdToken(e){return this.configurationService.getOpenIDConfiguration(e).pipe(w(t=>this.authStateService.getIdToken(t)))}getRefreshToken(e){return this.configurationService.getOpenIDConfiguration(e).pipe(w(t=>this.authStateService.getRefreshToken(t)))}getAuthenticationResult(e){return this.configurationService.getOpenIDConfiguration(e).pipe(w(t=>this.authStateService.getAuthenticationResult(t)))}getPayloadFromIdToken(e=!1,t){return this.configurationService.getOpenIDConfiguration(t).pipe(w(r=>{let i=this.authStateService.getIdToken(r);return this.tokenHelperService.getPayloadFromToken(i,e,r)}))}getPayloadFromAccessToken(e=!1,t){return this.configurationService.getOpenIDConfiguration(t).pipe(w(r=>{let i=this.authStateService.getAccessToken(r);return this.tokenHelperService.getPayloadFromToken(i,e,r)}))}setState(e,t){return this.configurationService.getOpenIDConfiguration(t).pipe(w(r=>this.flowsDataService.setAuthStateControl(e,r)))}getState(e){return this.configurationService.getOpenIDConfiguration(e).pipe(w(t=>this.flowsDataService.getAuthStateControl(t)))}authorize(e,t){this.configurationService.getOpenIDConfiguration(e).subscribe(r=>this.loginService.login(r,t))}authorizeWithPopUp(e,t,r){return this.configurationService.getOpenIDConfigurations(r).pipe(I(({allConfigs:i,currentConfig:n})=>this.loginService.loginWithPopUp(n,i,e,t)))}forceRefreshSession(e,t){return this.configurationService.getOpenIDConfigurations(t).pipe(I(({allConfigs:r,currentConfig:i})=>this.refreshSessionService.userForceRefreshSession(i,r,e)))}logoffAndRevokeTokens(e,t){return this.configurationService.getOpenIDConfigurations(e).pipe(I(({allConfigs:r,currentConfig:i})=>this.logoffRevocationService.logoffAndRevokeTokens(i,r,t)))}logoff(e,t){return this.configurationService.getOpenIDConfigurations(e).pipe(I(({allConfigs:r,currentConfig:i})=>this.logoffRevocationService.logoff(i,r,t)))}logoffLocal(e){this.configurationService.getOpenIDConfigurations(e).subscribe(({allConfigs:t,currentConfig:r})=>this.logoffRevocationService.logoffLocal(r,t))}logoffLocalMultiple(){this.configurationService.getOpenIDConfigurations().subscribe(({allConfigs:e})=>this.logoffRevocationService.logoffLocalMultiple(e))}revokeAccessToken(e,t){return this.configurationService.getOpenIDConfiguration(t).pipe(I(r=>this.logoffRevocationService.revokeAccessToken(r,e)))}revokeRefreshToken(e,t){return this.configurationService.getOpenIDConfiguration(t).pipe(I(r=>this.logoffRevocationService.revokeRefreshToken(r,e)))}getEndSessionUrl(e,t){return this.configurationService.getOpenIDConfiguration(t).pipe(w(r=>this.urlService.getEndSessionUrl(r,e)))}getAuthorizeUrl(e,t){return this.configurationService.getOpenIDConfiguration(t).pipe(I(r=>this.urlService.getAuthorizeUrl(r,e?{customParams:e}:void 0)))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})(),kr=(()=>{class s{read(e){return sessionStorage.getItem(e)}write(e,t){sessionStorage.setItem(e,t)}remove(e){sessionStorage.removeItem(e)}clear(){sessionStorage.clear()}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();function zr(s,...u){let e=Ir(s);for(let t of u)e.push(...t.\u0275providers);return He(e)}function Ir(s){return[{provide:Je,useValue:s},s?.loader||{provide:ce,useFactory:kt,deps:[Je]},{provide:et,useClass:kr},{provide:Ze,useClass:It}]}function dt(s){return s.reduce((u,e)=>u.concat(Array.isArray(e)?dt(e):e),[])}function mr(s){let u=yr(s);return new RegExp(`^${u}$`)}function yr(s){return s.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*")}var Rr=(()=>{class s{getConfigIdForClosestMatchingRoute(e,t){for(let r of t){let{secureRoutes:i}=r,n=(i??[]).find(a=>this.routeMatches(a,e));if(n)return{matchingRoute:n,matchingConfig:r}}return{matchingRoute:null,matchingConfig:null}}routeMatches(e,t){return t.startsWith(e)||this.matchesRoute(e,t)}matchesRoute(e,t){return mr(e).test(t)}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();function qr(){return(s,u)=>Dr(s,u,{configurationService:o(ye),authStateService:o(W),closestMatchingRouteService:o(Rr),loggerService:o(S)})}function Dr(s,u,e){if(!e.configurationService.hasAtLeastOneConfig())return u(s);let t=e.configurationService.getAllConfigurations(),r=t.map(l=>l.secureRoutes||[]);if(dt(r).length===0)return e.loggerService.logDebug(t[0],"No routes to check configured"),u(s);let{matchingConfig:n,matchingRoute:a}=e.closestMatchingRouteService.getConfigIdForClosestMatchingRoute(s.url,t);if(!n)return e.loggerService.logDebug(t[0],`Did not find any configured route for route ${s.url}`),u(s);e.loggerService.logDebug(n,`'${s.url}' matches configured route '${a}'`);let c=e.authStateService.getAccessToken(n);return c?(e.loggerService.logDebug(n,`'${s.url}' matches configured route '${a}', adding token`),s=s.clone({headers:s.headers.set("Authorization","Bearer "+c)}),u(s)):(e.loggerService.logDebug(n,`Wanted to add token to ${s.url} but found no token: '${c}'`),u(s))}var ve=[];function gt(){let s={};for(let u of ve)s[u.name]=u.signal();return s}function Er(){let s="";return{attachState(u,e){let t=e?.name??`signal_${ve.length}`;if(ve.some(i=>i.signal===u))return;ve.push({name:t,signal:u});let r=gt();s=JSON.stringify(r),console.log(`${t}/INIT`,r),xe(()=>{let i=gt(),n=JSON.stringify(i);n!==s&&(s=n,console.log("STORE_UPDATE",i))})}}}var vt=Er();var br={isAuthenticated:!1},ft=class s{#t=o(ut);#e=X(this.#t.checkAuth(),{initialValue:br});isAuthenticated=z(()=>this.#e().isAuthenticated,{});userData=z(()=>this.#e().userData,{});auth=z(()=>this.#e(),{});token=z(()=>this.#e().accessToken,{});roles=z(()=>{let u=this.token();return u?JSON.parse(atob(u?.split(".")[1]))?.realm_access?.roles||[]:null},{});constructor(){vt.attachState(this.auth,{name:"AuthStore"})}login(){this.#t.authorize()}logout(){return Pe(this.#t.logoff())}static \u0275fac=function(e){return new(e||s)};static \u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})};export{zr as a,qr as b,vt as c,ft as d};
